<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Data Wrangling &#8212; DataTech 1.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Data Visualization" href="visualization.html" />
    <link rel="prev" title="Statistical Learning Machines" href="learning.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="data-wrangling">
<h1>Data Wrangling<a class="headerlink" href="#data-wrangling" title="Permalink to this headline">¶</a></h1>
<p>In this chapter, we will see the following:</p>
<ul class="simple">
<li>DataFrames in Python with Pandas</li>
<li>Datetimes and indexing</li>
<li>Aggregating, transforming, and joining data</li>
<li>Missing data and imputation</li>
</ul>
<p>The dataset used in this Chapter comes from the <a class="reference external" href="https://www.transtats.bts.gov/databases.asp">Bureau of Transportation Statistics</a> .</p>
<div class="section" id="introduction-to-pandas">
<h2>Introduction to Pandas<a class="headerlink" href="#introduction-to-pandas" title="Permalink to this headline">¶</a></h2>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
<p>One might think that we have everything that we need to work with data.
We can read data with built-in Python functions and we can store and
manipulate that data with Numpy. Numpy is based around the Array, and
Pandas is based around the DataFrame. Unlike the Array, the Dataframe
treats each axis differently, with named columns and indexed rows.
Pandas does this under the assumption that a DataFrame holds a large
sample of a limited number of variables. Each column corresponds to a
variable, while each row corresponds to an individual, time-point, or
other index for repeated data.</p>
<p>Due to this presumption, Pandas is able to optimize operations such as
indexing, aggregation, and time series statistics. It also has great
Input/Output tools for reading delimited data, working with databases,
and HDF5 data. Pandas is built around the data types: DataFrames,
Series. Roughly, a Series is a list of indices and values (think of a
time series where the datatime is the index), and a DataFrame is a
dictionary where the keys are the column names and the values are entire
Series, and these Series have a common index. This is a high-level
overview of Pandas, and for more syntax details see
<a class="reference external" href="http://pandas.pydata.org/pandas-docs/stable/">the panda docs</a></p>
<div class="section" id="series">
<h3>Series<a class="headerlink" href="#series" title="Permalink to this headline">¶</a></h3>
<p>Let&#8217;s simulate a Brownian motion so that we can discuss Series objects.
You can see a plot of this below, we will go over data visualization in
the next chapter.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">T</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">innov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">T</span><span class="p">)</span>
<span class="n">brown</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">innov</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">brown</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/stock1.png" src="../_images/stock1.png" />
<p>Let&#8217;s suppose that the above simulation represents the change in a stock
price starting from Jan 1, 2015. Pandas provides a tool for making
sequences of datetimes; the following makes a DateTimeIndex object.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">days</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;1/1/2015&#39;</span><span class="p">,</span><span class="n">periods</span><span class="o">=</span><span class="n">T</span><span class="p">,</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We will return to datetime functionality in Pandas later. Another option
for working with datetimes is the <code class="docutils literal"><span class="pre">datetime</span></code> package, which has the
date, time, and datetime types and a timedelta object for increments of
time. To see the specifics of the <code class="docutils literal"><span class="pre">datetime</span></code> package you can look at
<a class="reference external" href="https://docs.python.org/3.7/library/datetime.html">the datetime documentation</a></p>
<p>The resulting list contains the dates, for example,</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">days</span><span class="p">[</span><span class="mi">600</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2016-08-23 00:00:00&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We can initialize a series with a 1D array and an index sequence. If you
omit the index then it will index with the row number. You can also
initialize with dictionaries where the index values are the keys and the
values are the data.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">stock</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">brown</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">days</span><span class="p">)</span>
</pre></div>
</div>
<p>The Series object should be thought of as a vector of data where each
value is attached to an index value. Series operations will preserve the
indices when they can. You can slice a series as if it were an array; in
the following, we look at every seventh day in the first 100 days.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">stock</span><span class="p">[:</span><span class="mi">100</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">2015</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span>   <span class="o">-</span><span class="mf">0.132526</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">08</span>    <span class="mf">3.900432</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">15</span>    <span class="mf">7.371181</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">22</span>    <span class="mf">6.224340</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">29</span>    <span class="mf">3.449301</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">05</span>    <span class="mf">1.346746</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">12</span>    <span class="mf">2.084879</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">19</span>   <span class="o">-</span><span class="mf">0.752967</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">26</span>   <span class="o">-</span><span class="mf">0.983502</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">05</span>   <span class="o">-</span><span class="mf">0.575965</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">12</span>    <span class="mf">1.140087</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">19</span>   <span class="o">-</span><span class="mf">2.205040</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">26</span>   <span class="o">-</span><span class="mf">2.214539</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">02</span>   <span class="o">-</span><span class="mf">1.170000</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">09</span>   <span class="o">-</span><span class="mf">1.984565</span>
<span class="n">Freq</span><span class="p">:</span> <span class="mi">7</span><span class="n">D</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</pre></div>
</div>
<p>Due to the indexing, we can also think of this as a dictionary, as in
the following.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;2016/7/27&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mf">11.191250684953793</span>
</pre></div>
</div>
<p>One of the key features that makes the series different from an array is
that operations between two series will align the indices. For example,
suppose that we have bought 100 shares of another stock on Jan 1, 2016,
which we can simulate as well. As usual, since we are reusing code,
let&#8217;s wrap it up in a function which we could put in a module.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">stock_sim</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">day1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simulate a stock for T days starting from day1&quot;&quot;&quot;</span>
    <span class="n">innov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">T</span><span class="p">)</span>
    <span class="n">brown</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">innov</span><span class="p">)</span>
    <span class="n">days</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">day1</span><span class="p">,</span><span class="n">periods</span><span class="o">=</span><span class="n">T</span><span class="p">,</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">brown</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">days</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">T</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">-</span> <span class="mi">365</span>
<span class="n">day1</span> <span class="o">=</span> <span class="s1">&#39;2016/1/1&#39;</span>
<span class="n">stock_2</span> <span class="o">=</span> <span class="n">stock_sim</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">day1</span><span class="p">)</span>
</pre></div>
</div>
<p>For each date we would like to see the difference between the value of
the portfolio and the amount we spent on the portfolio. This is
proportional to the sum of the two changes in stock price since we have
bought even amounts of each stock.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">portfolio</span> <span class="o">=</span> <span class="n">stock</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">stock_2</span><span class="p">,</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">stock</span></code> and <code class="docutils literal"><span class="pre">stock_2</span></code> have different lengths but we are able to add
them because the indices can be matched. So after 2016 the change in
value of stock 2 is added to stock 1 since that will correspond to the
change in portfolio value. We had to specify a <code class="docutils literal"><span class="pre">fill_value</span></code> of 0
otherwise it would try report the portfolio value as missing before
2016. We can plot this.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># See next chapter</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">portfolio</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Portfolio gain&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">autofmt_xdate</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/portfolio.png" src="../_images/portfolio.png" />
</div>
<div class="section" id="dataframe">
<h3>Dataframe<a class="headerlink" href="#dataframe" title="Permalink to this headline">¶</a></h3>
<p>You should think of a dataframe as a collection of series objects with a
common index. Each series in the dataframe has a different name, and
they should be thought of as different variables. We can initialize the
dataframe with a dictionary mapping names to series objects.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">port_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;stock 1&#39;</span><span class="p">:</span><span class="n">stock</span><span class="p">,</span><span class="s1">&#39;stock 2&#39;</span><span class="p">:</span><span class="n">stock_2</span><span class="p">,</span><span class="s1">&#39;portfolio&#39;</span><span class="p">:</span><span class="n">portfolio</span><span class="p">})</span>
</pre></div>
</div>
<p>If we had passed arrays instead of series then the default index of the
row numbers would be used. You can also pass a 2D array and specify the
<code class="docutils literal"><span class="pre">indices</span></code> and <code class="docutils literal"><span class="pre">columns</span></code> arguments. There are other ways to
initialize a dataframe, such as from lists of tuples and lists of
dictionaries.</p>
<p>We can view the first few rows of any dataframe with the <code class="docutils literal"><span class="pre">head</span></code>
method.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">port_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>stock 1</th>
      <th>stock 2</th>
      <th>portfolio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-01-01</th>
      <td>-0.132526</td>
      <td>NaN</td>
      <td>-0.132526</td>
    </tr>
    <tr>
      <th>2015-01-02</th>
      <td>-0.087030</td>
      <td>NaN</td>
      <td>-0.087030</td>
    </tr>
    <tr>
      <th>2015-01-03</th>
      <td>-1.578688</td>
      <td>NaN</td>
      <td>-1.578688</td>
    </tr>
    <tr>
      <th>2015-01-04</th>
      <td>-0.240958</td>
      <td>NaN</td>
      <td>-0.240958</td>
    </tr>
    <tr>
      <th>2015-01-05</th>
      <td>1.170581</td>
      <td>NaN</td>
      <td>1.170581</td>
    </tr>
  </tbody>
</table>
</div><p>We see that stock 2 was filled with NaN values. We can also get at the
indices and names via</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">port_df</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="mi">7</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">port_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">DatetimeIndex</span><span class="p">([</span><span class="s1">&#39;2015-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2015-01-02&#39;</span><span class="p">,</span> <span class="s1">&#39;2015-01-03&#39;</span><span class="p">,</span> <span class="s1">&#39;2015-01-04&#39;</span><span class="p">,</span>
               <span class="s1">&#39;2015-01-05&#39;</span><span class="p">,</span> <span class="s1">&#39;2015-01-06&#39;</span><span class="p">,</span> <span class="s1">&#39;2015-01-07&#39;</span><span class="p">],</span>
              <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="n">Index</span><span class="p">([</span><span class="s1">&#39;stock 1&#39;</span><span class="p">,</span> <span class="s1">&#39;stock 2&#39;</span><span class="p">,</span> <span class="s1">&#39;portfolio&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;object&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Accessing elements in a dataframe differs from arrays in the following
ways:</p>
<ul class="simple">
<li>dataframes act like dictionaries from the column names to the column</li>
<li>slicing is done over the row indices</li>
<li>to</li>
</ul>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">port_df</span><span class="p">[</span><span class="s1">&#39;stock 1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span> <span class="c1"># this returns the column</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">2015</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span>   <span class="o">-</span><span class="mf">0.132526</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span>   <span class="o">-</span><span class="mf">0.087030</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span>   <span class="o">-</span><span class="mf">1.578688</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">04</span>   <span class="o">-</span><span class="mf">0.240958</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">05</span>    <span class="mf">1.170581</span>
<span class="n">Freq</span><span class="p">:</span> <span class="n">D</span><span class="p">,</span> <span class="n">Name</span><span class="p">:</span> <span class="n">stock</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">port_df</span><span class="p">[</span><span class="s1">&#39;2015/1/1&#39;</span><span class="p">:</span><span class="s1">&#39;2016/1/1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span> <span class="c1">#this returns a slice of rows</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>stock 1</th>
      <th>stock 2</th>
      <th>portfolio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-01-01</th>
      <td>-0.132526</td>
      <td>NaN</td>
      <td>-0.132526</td>
    </tr>
    <tr>
      <th>2015-01-02</th>
      <td>-0.087030</td>
      <td>NaN</td>
      <td>-0.087030</td>
    </tr>
    <tr>
      <th>2015-01-03</th>
      <td>-1.578688</td>
      <td>NaN</td>
      <td>-1.578688</td>
    </tr>
    <tr>
      <th>2015-01-04</th>
      <td>-0.240958</td>
      <td>NaN</td>
      <td>-0.240958</td>
    </tr>
    <tr>
      <th>2015-01-05</th>
      <td>1.170581</td>
      <td>NaN</td>
      <td>1.170581</td>
    </tr>
  </tbody>
</table>
</div><p>Boolean fancy indexing works in the place of the slice above as well,
for example, we can select rows with a boolean series,</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">port_df</span><span class="p">[</span><span class="n">port_df</span><span class="p">[</span><span class="s1">&#39;portfolio&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">port_df</span><span class="p">[</span><span class="s1">&#39;stock 1&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>stock 1</th>
      <th>stock 2</th>
      <th>portfolio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2016-01-01</th>
      <td>8.154289</td>
      <td>0.702001</td>
      <td>8.856290</td>
    </tr>
    <tr>
      <th>2016-01-12</th>
      <td>3.746795</td>
      <td>0.412568</td>
      <td>4.159364</td>
    </tr>
    <tr>
      <th>2016-01-13</th>
      <td>1.930705</td>
      <td>0.585910</td>
      <td>2.516615</td>
    </tr>
    <tr>
      <th>2016-01-18</th>
      <td>-2.250490</td>
      <td>0.158522</td>
      <td>-2.091968</td>
    </tr>
    <tr>
      <th>2016-01-19</th>
      <td>-1.874360</td>
      <td>0.796581</td>
      <td>-1.077779</td>
    </tr>
  </tbody>
</table>
</div><p>which will find the elements in which the portfolio is better off than
just our share in stock 1. The comparison between the portfolio and
stock 1 is not quite fair because we invested more money in the
portfolio. We can create new columns via the following assignment,</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">s1sim</span> <span class="o">=</span> <span class="n">port_df</span><span class="p">[</span><span class="s1">&#39;stock 1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">port_df</span><span class="p">[</span><span class="s1">&#39;stock 1&#39;</span><span class="p">][</span><span class="s1">&#39;2016/1/1&#39;</span><span class="p">:],</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">port_df</span><span class="p">[</span><span class="s1">&#39;stock 1 sim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s1sim</span>
<span class="n">port_df</span><span class="p">[</span><span class="n">port_df</span><span class="p">[</span><span class="s1">&#39;portfolio&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">port_df</span><span class="p">[</span><span class="s1">&#39;stock 1 sim&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>stock 1</th>
      <th>stock 2</th>
      <th>portfolio</th>
      <th>stock 1 sim</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2016-01-16</th>
      <td>-2.004913</td>
      <td>-1.310433</td>
      <td>-3.315347</td>
      <td>-4.009827</td>
    </tr>
    <tr>
      <th>2016-01-17</th>
      <td>-2.863114</td>
      <td>-0.532889</td>
      <td>-3.396003</td>
      <td>-5.726228</td>
    </tr>
    <tr>
      <th>2016-01-18</th>
      <td>-2.250490</td>
      <td>0.158522</td>
      <td>-2.091968</td>
      <td>-4.500980</td>
    </tr>
    <tr>
      <th>2016-01-19</th>
      <td>-1.874360</td>
      <td>0.796581</td>
      <td>-1.077779</td>
      <td>-3.748719</td>
    </tr>
    <tr>
      <th>2016-01-20</th>
      <td>-1.835044</td>
      <td>1.822567</td>
      <td>-0.012477</td>
      <td>-3.670089</td>
    </tr>
  </tbody>
</table>
</div><p>We added the value of stock 1 after 2016 to all of stock 1 to see what
the price would be if we invested in stock 1 again on Jan 1, 2016. If we
wanted to select instead a specific date, we would need to use the
<code class="docutils literal"><span class="pre">loc</span></code> method,</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">port_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2016/7/27&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">stock</span> <span class="mi">1</span>        <span class="mf">11.191251</span>
<span class="n">stock</span> <span class="mi">2</span>         <span class="mf">2.867483</span>
<span class="n">portfolio</span>      <span class="mf">14.058734</span>
<span class="n">stock</span> <span class="mi">1</span> <span class="n">sim</span>    <span class="mf">22.382501</span>
<span class="n">Name</span><span class="p">:</span> <span class="mi">2016</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">27</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</pre></div>
</div>
<p>We can select and slice the dataframe as if it were a Numpy array using
the <code class="docutils literal"><span class="pre">iloc</span></code> method,</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">port_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">400</span><span class="p">:</span><span class="mi">405</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>stock 1</th>
      <th>stock 2</th>
      <th>portfolio</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2016-02-05</th>
      <td>-3.581697</td>
      <td>6.968880</td>
      <td>3.387182</td>
    </tr>
    <tr>
      <th>2016-02-06</th>
      <td>-3.854760</td>
      <td>6.472026</td>
      <td>2.617266</td>
    </tr>
    <tr>
      <th>2016-02-07</th>
      <td>-2.697462</td>
      <td>7.555933</td>
      <td>4.858471</td>
    </tr>
    <tr>
      <th>2016-02-08</th>
      <td>-4.389190</td>
      <td>10.106156</td>
      <td>5.716965</td>
    </tr>
    <tr>
      <th>2016-02-09</th>
      <td>-4.027021</td>
      <td>8.067919</td>
      <td>4.040898</td>
    </tr>
  </tbody>
</table>
</div><p>Other things to be aware of are</p>
<ul class="simple">
<li>the <code class="docutils literal"><span class="pre">info</span></code> method which provides the types and information of the
columns,</li>
<li>many elementwise Numpy operations can be performed on series and
dataframes, such as <code class="docutils literal"><span class="pre">np.exp</span></code></li>
<li>Pandas has many of the same descriptive statistics such as
<code class="docutils literal"><span class="pre">dataframe.mean()</span></code> including <code class="docutils literal"><span class="pre">min,</span> <span class="pre">max,</span> <span class="pre">std,</span> <span class="pre">count,...</span></code></li>
</ul>
<p>We can see many of the descriptive statistics with the <code class="docutils literal"><span class="pre">describe</span></code>
method.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">port_df</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>stock 1</th>
      <th>stock 2</th>
      <th>portfolio</th>
      <th>stock 1 sim</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>1000.000000</td>
      <td>635.000000</td>
      <td>1000.000000</td>
      <td>1000.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>2.209039</td>
      <td>8.755110</td>
      <td>7.768534</td>
      <td>2.802033</td>
    </tr>
    <tr>
      <th>std</th>
      <td>6.782089</td>
      <td>9.029220</td>
      <td>11.534137</td>
      <td>12.119164</td>
    </tr>
    <tr>
      <th>min</th>
      <td>-13.394813</td>
      <td>-14.372408</td>
      <td>-20.329462</td>
      <td>-26.789627</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>-2.834049</td>
      <td>3.965685</td>
      <td>0.280122</td>
      <td>-4.962457</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>3.748605</td>
      <td>11.666626</td>
      <td>7.178422</td>
      <td>4.646818</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>7.014775</td>
      <td>15.381508</td>
      <td>16.705302</td>
      <td>10.896449</td>
    </tr>
    <tr>
      <th>max</th>
      <td>16.995441</td>
      <td>23.052934</td>
      <td>32.141200</td>
      <td>29.696000</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="section" id="wrangling-data-with-indices">
<h2>Wrangling data with indices<a class="headerlink" href="#wrangling-data-with-indices" title="Permalink to this headline">¶</a></h2>
<div class="section" id="reading-data-and-datetime-indexing">
<h3>Reading data and datetime indexing<a class="headerlink" href="#reading-data-and-datetime-indexing" title="Permalink to this headline">¶</a></h3>
<p>In this section, we will go over reading data with Pandas and datetime
functionality. This is meant to explain why these tools exist and their
basic functionality. For more detail, look at</p>
<ul class="simple">
<li><a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/timeseries.html">Pandas timeseries docs</a></li>
<li><a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/io.html">Pandas I/O docs</a></li>
</ul>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
<p>Pandas is especially useful because of its excellent Input/Output (I/O)
functions. The <code class="docutils literal"><span class="pre">read_csv</span></code> command has a few different ways of working.
If you specify that you want an iterator, with the iterator argument,
then you can get something that works like the CSV reader object. You
can also specify a chunksize, and then it returns an iterator that will
read the file in chunks (the first k likes, then the next k, etc.),
which is great for files that you cannot store in memory. By default
read_csv loads the file all at once. For example, we could read in all
of the following data file:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">colnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Origin&#39;</span><span class="p">,</span><span class="s1">&#39;Dest&#39;</span><span class="p">,</span><span class="s1">&#39;Origin City&#39;</span><span class="p">,</span><span class="s1">&#39;Dest City&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Passengers&#39;</span><span class="p">,</span><span class="s1">&#39;Seats&#39;</span><span class="p">,</span><span class="s1">&#39;Flights&#39;</span><span class="p">,</span><span class="s1">&#39;Distance&#39;</span><span class="p">,</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span><span class="s1">&#39;Origin Pop&#39;</span><span class="p">,</span><span class="s1">&#39;Dest Pop&#39;</span><span class="p">]</span>
<span class="n">flights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/flight_red.tsv&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="n">colnames</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">flights</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 1140706 entries, 0 to 1140705
Data columns (total 11 columns):
Origin         1140706 non-null object
Dest           1140706 non-null object
Origin City    1140706 non-null object
Dest City      1140706 non-null object
Passengers     1140706 non-null int64
Seats          1140706 non-null int64
Flights        1140706 non-null int64
Distance       1140706 non-null float64
Date           1140706 non-null int64
Origin Pop     1140706 non-null int64
Dest Pop       1140706 non-null int64
dtypes: float64(1), int64(6), object(4)
memory usage: 95.7+ MB
</pre></div>
</div>
<p>Let&#8217;s suppose that we did not want to work with over 1 million rows at
once, and will instead just work in chunks. We can use the chunksize
argument, which will then create an iterator that will yield DataFrames
with that number of rows.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">flights_it</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/flight_red.tsv&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">chunksize</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">colnames</span><span class="p">)</span>
<span class="n">flights</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">flights_it</span><span class="p">)</span>
<span class="n">flights</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">100000</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
</pre></div>
</div>
<p>We have a dataframe with the same dtypes that we see from the output of
<code class="docutils literal"><span class="pre">info()</span></code> above, but with 100,000 rows. Let&#8217;s look at the head of this
dataframe.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">flights</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Origin</th>
      <th>Dest</th>
      <th>Origin City</th>
      <th>Dest City</th>
      <th>Passengers</th>
      <th>Seats</th>
      <th>Flights</th>
      <th>Distance</th>
      <th>Date</th>
      <th>Origin Pop</th>
      <th>Dest Pop</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>MHK</td>
      <td>AMW</td>
      <td>Manhattan, KS</td>
      <td>Ames, IA</td>
      <td>21</td>
      <td>30</td>
      <td>1</td>
      <td>254.0</td>
      <td>200810</td>
      <td>122049</td>
      <td>86219</td>
    </tr>
    <tr>
      <th>1</th>
      <td>PDX</td>
      <td>RDM</td>
      <td>Portland, OR</td>
      <td>Bend, OR</td>
      <td>5186</td>
      <td>6845</td>
      <td>185</td>
      <td>116.0</td>
      <td>200508</td>
      <td>2084053</td>
      <td>140962</td>
    </tr>
    <tr>
      <th>2</th>
      <td>PDX</td>
      <td>RDM</td>
      <td>Portland, OR</td>
      <td>Bend, OR</td>
      <td>2781</td>
      <td>4650</td>
      <td>155</td>
      <td>116.0</td>
      <td>200508</td>
      <td>2084053</td>
      <td>140962</td>
    </tr>
    <tr>
      <th>3</th>
      <td>PDX</td>
      <td>RDM</td>
      <td>Portland, OR</td>
      <td>Bend, OR</td>
      <td>66</td>
      <td>70</td>
      <td>1</td>
      <td>116.0</td>
      <td>200502</td>
      <td>2084053</td>
      <td>140962</td>
    </tr>
    <tr>
      <th>4</th>
      <td>PDX</td>
      <td>RDM</td>
      <td>Portland, OR</td>
      <td>Bend, OR</td>
      <td>3791</td>
      <td>5143</td>
      <td>139</td>
      <td>116.0</td>
      <td>200502</td>
      <td>2084053</td>
      <td>140962</td>
    </tr>
  </tbody>
</table>
</div><p>There are several other similar methods for reading filetypes other than
CSV. For example, <code class="docutils literal"><span class="pre">read_excel,</span> <span class="pre">read_hdf,</span> <span class="pre">read_stata,</span> <span class="pre">read_sas</span></code> will
read excel, HDF5, Stata, and SAS files. We will return to reading JSON
and HTML files later, but will generally not use Pandas for these.</p>
<p>If we look at the Date column, we see that this is currently a string
(called an Object in Pandas&#8212;this is related to json). It should be a
date, so let&#8217;s convert it using <code class="docutils literal"><span class="pre">pd.t_datetime</span></code>.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">flights</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">flights</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">],</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y%m&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">flights</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Origin</th>
      <th>Dest</th>
      <th>Origin City</th>
      <th>Dest City</th>
      <th>Passengers</th>
      <th>Seats</th>
      <th>Flights</th>
      <th>Distance</th>
      <th>Date</th>
      <th>Origin Pop</th>
      <th>Dest Pop</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>MHK</td>
      <td>AMW</td>
      <td>Manhattan, KS</td>
      <td>Ames, IA</td>
      <td>21</td>
      <td>30</td>
      <td>1</td>
      <td>254.0</td>
      <td>2008-10-01</td>
      <td>122049</td>
      <td>86219</td>
    </tr>
    <tr>
      <th>1</th>
      <td>PDX</td>
      <td>RDM</td>
      <td>Portland, OR</td>
      <td>Bend, OR</td>
      <td>5186</td>
      <td>6845</td>
      <td>185</td>
      <td>116.0</td>
      <td>2005-08-01</td>
      <td>2084053</td>
      <td>140962</td>
    </tr>
    <tr>
      <th>2</th>
      <td>PDX</td>
      <td>RDM</td>
      <td>Portland, OR</td>
      <td>Bend, OR</td>
      <td>2781</td>
      <td>4650</td>
      <td>155</td>
      <td>116.0</td>
      <td>2005-08-01</td>
      <td>2084053</td>
      <td>140962</td>
    </tr>
    <tr>
      <th>3</th>
      <td>PDX</td>
      <td>RDM</td>
      <td>Portland, OR</td>
      <td>Bend, OR</td>
      <td>66</td>
      <td>70</td>
      <td>1</td>
      <td>116.0</td>
      <td>2005-02-01</td>
      <td>2084053</td>
      <td>140962</td>
    </tr>
    <tr>
      <th>4</th>
      <td>PDX</td>
      <td>RDM</td>
      <td>Portland, OR</td>
      <td>Bend, OR</td>
      <td>3791</td>
      <td>5143</td>
      <td>139</td>
      <td>116.0</td>
      <td>2005-02-01</td>
      <td>2084053</td>
      <td>140962</td>
    </tr>
  </tbody>
</table>
</div><p>Converting this to datetime makes each individual entry a Timestamp
object.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">ts</span> <span class="o">=</span> <span class="n">flights</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span>
<span class="n">ts</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2008-10-01 00:00:00&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The Timestamp should be thought of as a point in time, and it can have
resolution down to the nanosecond. The other type of datetime in Pandas
is the Period, which should be thought of as a range of time. It is
clear from the dataset that we are actually dealing with monthly periods
of time, and every number there is an aggregate of the flights in that
month. We can convert individual Timestamps into Periods by initializing
a Period instance and specifying a frequency.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">Period</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Period</span><span class="p">(</span><span class="s1">&#39;2008-10&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Pandas allows us to manipulate Timestamps and Periods using the offset
module.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">ts</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Hour</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2008-10-01 02:00:00&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The Period is has a frequency, and you can add an offset that is
consistent with that frequency. For example,</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Period</span><span class="p">(</span><span class="s1">&#39;2014-07-01 09:00&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>
<span class="n">p</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Day</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Period</span><span class="p">(</span><span class="s1">&#39;2014-07-03&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>works, while the following does not</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Period</span><span class="p">(</span><span class="s1">&#39;2014-07-01 09:00&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>
<span class="n">p</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Day</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">---------------------------------------------------------------------------</span>

<span class="n">IncompatibleFrequency</span>                     <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>

<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">199</span><span class="o">-</span><span class="n">be7758fde5ae</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span><span class="p">()</span>
      <span class="mi">1</span> <span class="n">p</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Period</span><span class="p">(</span><span class="s1">&#39;2014-07-01 09:00&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>
<span class="o">----&gt;</span> <span class="mi">2</span> <span class="n">p</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Day</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>


<span class="n">pandas</span><span class="o">/</span><span class="n">_libs</span><span class="o">/</span><span class="n">tslibs</span><span class="o">/</span><span class="n">period</span><span class="o">.</span><span class="n">pyx</span> <span class="ow">in</span> <span class="n">pandas</span><span class="o">.</span><span class="n">_libs</span><span class="o">.</span><span class="n">tslibs</span><span class="o">.</span><span class="n">period</span><span class="o">.</span><span class="n">_Period</span><span class="o">.</span><span class="fm">__add__</span><span class="p">()</span>


<span class="n">pandas</span><span class="o">/</span><span class="n">_libs</span><span class="o">/</span><span class="n">tslibs</span><span class="o">/</span><span class="n">period</span><span class="o">.</span><span class="n">pyx</span> <span class="ow">in</span> <span class="n">pandas</span><span class="o">.</span><span class="n">_libs</span><span class="o">.</span><span class="n">tslibs</span><span class="o">.</span><span class="n">period</span><span class="o">.</span><span class="n">_Period</span><span class="o">.</span><span class="n">_add_delta</span><span class="p">()</span>


<span class="n">IncompatibleFrequency</span><span class="p">:</span> <span class="n">Input</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">converted</span> <span class="n">to</span> <span class="n">Period</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="n">M</span><span class="p">)</span>
</pre></div>
</div>
<p>because of the offset has resolution that is smaller than the frequency.</p>
<p>The Timestamp has a resolution, which acts a lot like the frequency of
the Period, so why use one over the other? Because the Period is assumed
to be a range of time, it has some attributes and methods that the
Timestamp does not and vice versa. For example,</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">p</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">end_time</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2014-07-01 00:00:00&#39;</span><span class="p">),</span> <span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2014-07-31 23:59:59.999999999&#39;</span><span class="p">))</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">day_name</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="s1">&#39;Wednesday&#39;</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">start_time</span></code> and <code class="docutils literal"><span class="pre">end_time</span></code> can be used to test if a Timestamp
falls within a Period. Also, the Timestamp has, for example, the
<code class="docutils literal"><span class="pre">day_name</span></code> method.</p>
<p>You can also subtract a Timestamp Series by an offset, or if you have a
DatetimeIndex (or PeriodIndex) you can use the Shift method.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">dts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;1998-12-30&#39;</span><span class="p">,</span> <span class="s1">&#39;2000-5-5&#39;</span><span class="p">))</span>
<span class="n">lag</span> <span class="o">=</span> <span class="n">dts</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Day</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">lag</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">1998</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">30</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="mi">1998</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">dti</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">dts</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dti</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dti</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">1998</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">30</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="mi">1998</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">29</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
</pre></div>
</div>
<p>If we will be using a Period for indexing we can create a PeriodIndex
object. The PeriodIndex and the DatetimeIndex are both special types
that should be used to construct an time index for the DataFrame. Quite
often, but not always, a datetime is a natural choice of index for the
DataFrame, instead of the row number. We set a column to be the index of
the DataFrame with the <code class="docutils literal"><span class="pre">set_index</span></code> method.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">flights</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">PeriodIndex</span><span class="p">(</span><span class="n">flights</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">],</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>
<span class="n">flights</span> <span class="o">=</span> <span class="n">flights</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">flights</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Origin</th>
      <th>Dest</th>
      <th>Origin City</th>
      <th>Dest City</th>
      <th>Passengers</th>
      <th>Seats</th>
      <th>Flights</th>
      <th>Distance</th>
      <th>Origin Pop</th>
      <th>Dest Pop</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2008-10</th>
      <td>MHK</td>
      <td>AMW</td>
      <td>Manhattan, KS</td>
      <td>Ames, IA</td>
      <td>21</td>
      <td>30</td>
      <td>1</td>
      <td>254.0</td>
      <td>122049</td>
      <td>86219</td>
    </tr>
    <tr>
      <th>2005-08</th>
      <td>PDX</td>
      <td>RDM</td>
      <td>Portland, OR</td>
      <td>Bend, OR</td>
      <td>5186</td>
      <td>6845</td>
      <td>185</td>
      <td>116.0</td>
      <td>2084053</td>
      <td>140962</td>
    </tr>
    <tr>
      <th>2005-08</th>
      <td>PDX</td>
      <td>RDM</td>
      <td>Portland, OR</td>
      <td>Bend, OR</td>
      <td>2781</td>
      <td>4650</td>
      <td>155</td>
      <td>116.0</td>
      <td>2084053</td>
      <td>140962</td>
    </tr>
    <tr>
      <th>2005-02</th>
      <td>PDX</td>
      <td>RDM</td>
      <td>Portland, OR</td>
      <td>Bend, OR</td>
      <td>66</td>
      <td>70</td>
      <td>1</td>
      <td>116.0</td>
      <td>2084053</td>
      <td>140962</td>
    </tr>
    <tr>
      <th>2005-02</th>
      <td>PDX</td>
      <td>RDM</td>
      <td>Portland, OR</td>
      <td>Bend, OR</td>
      <td>3791</td>
      <td>5143</td>
      <td>139</td>
      <td>116.0</td>
      <td>2084053</td>
      <td>140962</td>
    </tr>
  </tbody>
</table>
</div><p>Now that we have an index, we can select elements based on it, and slice
with it.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">flights</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2009-02&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Origin</th>
      <th>Dest</th>
      <th>Origin City</th>
      <th>Dest City</th>
      <th>Passengers</th>
      <th>Seats</th>
      <th>Flights</th>
      <th>Distance</th>
      <th>Origin Pop</th>
      <th>Dest Pop</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2009-02</th>
      <td>LAX</td>
      <td>RDM</td>
      <td>Los Angeles, CA</td>
      <td>Bend, OR</td>
      <td>1149</td>
      <td>1976</td>
      <td>26</td>
      <td>726.0</td>
      <td>25749594</td>
      <td>158629</td>
    </tr>
    <tr>
      <th>2009-02</th>
      <td>LAX</td>
      <td>RDM</td>
      <td>Los Angeles, CA</td>
      <td>Bend, OR</td>
      <td>62</td>
      <td>70</td>
      <td>1</td>
      <td>726.0</td>
      <td>25749594</td>
      <td>158629</td>
    </tr>
    <tr>
      <th>2009-02</th>
      <td>RNO</td>
      <td>RDM</td>
      <td>Reno, NV</td>
      <td>Bend, OR</td>
      <td>39</td>
      <td>74</td>
      <td>1</td>
      <td>336.0</td>
      <td>419261</td>
      <td>158629</td>
    </tr>
    <tr>
      <th>2009-02</th>
      <td>FAT</td>
      <td>RDM</td>
      <td>Fresno, CA</td>
      <td>Bend, OR</td>
      <td>0</td>
      <td>30</td>
      <td>1</td>
      <td>521.0</td>
      <td>915267</td>
      <td>158629</td>
    </tr>
    <tr>
      <th>2009-02</th>
      <td>AZA</td>
      <td>RDM</td>
      <td>Phoenix, AZ</td>
      <td>Bend, OR</td>
      <td>1019</td>
      <td>1200</td>
      <td>8</td>
      <td>911.0</td>
      <td>4364094</td>
      <td>158629</td>
    </tr>
  </tbody>
</table>
</div><p>In the above display we can see that Date is certainly not a unique
index, since the first several rows all correspond to the same Date.
Even if we specify an Origin, Dest, and Date you will not receive a
unique entry. Let&#8217;s focus just on the flights that are going from LAX to
DFW. We will then use <code class="docutils literal"><span class="pre">groupby</span></code> which will allow us to aggregate the
entries in the same month&#8212;we will return to this later.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">flight_sel</span> <span class="o">=</span> <span class="n">flights</span><span class="p">[(</span><span class="n">flights</span><span class="p">[</span><span class="s1">&#39;Origin&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;LAX&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">flights</span><span class="p">[</span><span class="s1">&#39;Dest&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;DFW&#39;</span><span class="p">)]</span>
<span class="n">flight_sel</span> <span class="o">=</span> <span class="n">flight_sel</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">flight_sel</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Passengers</th>
      <th>Seats</th>
      <th>Flights</th>
      <th>Distance</th>
      <th>Origin Pop</th>
      <th>Dest Pop</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2005-01</th>
      <td>72928</td>
      <td>96548</td>
      <td>645</td>
      <td>16055.0</td>
      <td>331790550</td>
      <td>151226582</td>
    </tr>
    <tr>
      <th>2005-02</th>
      <td>57787</td>
      <td>71029</td>
      <td>471</td>
      <td>13585.0</td>
      <td>280745850</td>
      <td>127960954</td>
    </tr>
    <tr>
      <th>2005-03</th>
      <td>71404</td>
      <td>79866</td>
      <td>531</td>
      <td>12350.0</td>
      <td>255223500</td>
      <td>116328140</td>
    </tr>
    <tr>
      <th>2005-04</th>
      <td>68931</td>
      <td>80668</td>
      <td>529</td>
      <td>12350.0</td>
      <td>255223500</td>
      <td>116328140</td>
    </tr>
    <tr>
      <th>2005-05</th>
      <td>72026</td>
      <td>87333</td>
      <td>577</td>
      <td>13585.0</td>
      <td>280745850</td>
      <td>127960954</td>
    </tr>
  </tbody>
</table>
</div><p>Another common operation for datetimes is to convert to different
frequencies, and interpolate new points. If we just want to change the
frequency of the datetimes, we can use the <code class="docutils literal"><span class="pre">asfreq</span></code> method which can
work of DatetimeIndex or PeriodIndex objects.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">flight_sel</span><span class="p">[</span><span class="s1">&#39;Passengers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">asfreq</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Date</span>
<span class="mi">2005</span>    <span class="mi">72928</span>
<span class="mi">2005</span>    <span class="mi">57787</span>
<span class="mi">2005</span>    <span class="mi">71404</span>
<span class="mi">2005</span>    <span class="mi">68931</span>
<span class="mi">2005</span>    <span class="mi">72026</span>
<span class="n">Freq</span><span class="p">:</span> <span class="n">A</span><span class="o">-</span><span class="n">DEC</span><span class="p">,</span> <span class="n">Name</span><span class="p">:</span> <span class="n">Passengers</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</pre></div>
</div>
<p>This merely forgets what the month was for that entry. <em>Downsampling</em>
means that we want to aggregate to give the index a lower frequency. For
example, we can downsample by summing all entries with the same year. To
do this we use the <code class="docutils literal"><span class="pre">resample</span></code> method, which you then need to pass to
an aggregation method to output a DataFrame.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">flight_sel</span><span class="p">[</span><span class="s1">&#39;Passengers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Date</span>
<span class="mi">2005</span>    <span class="mi">880936</span>
<span class="mi">2006</span>    <span class="mi">881529</span>
<span class="mi">2007</span>    <span class="mi">874082</span>
<span class="n">Freq</span><span class="p">:</span> <span class="n">A</span><span class="o">-</span><span class="n">DEC</span><span class="p">,</span> <span class="n">Name</span><span class="p">:</span> <span class="n">Passengers</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</pre></div>
</div>
<p><em>Upsampling</em> means that you will give the index a higher frequency, but
to do so we need to interpolate entries or add missingness. You can also
use <code class="docutils literal"><span class="pre">resample</span></code> for downsampling, and if you then use the <code class="docutils literal"><span class="pre">asfreq</span></code>
method, it will fill all but the first entry with missing values.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">flight_rs</span> <span class="o">=</span> <span class="n">flight_sel</span><span class="p">[</span><span class="s1">&#39;Passengers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">asfreq</span><span class="p">()</span>
<span class="n">flight_rs</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Date</span>
<span class="mi">2005</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span>    <span class="mf">72928.0</span>
<span class="mi">2005</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span>        <span class="n">NaN</span>
<span class="mi">2005</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span>        <span class="n">NaN</span>
<span class="mi">2005</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">04</span>        <span class="n">NaN</span>
<span class="mi">2005</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">05</span>        <span class="n">NaN</span>
<span class="n">Freq</span><span class="p">:</span> <span class="n">D</span><span class="p">,</span> <span class="n">Name</span><span class="p">:</span> <span class="n">Passengers</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</pre></div>
</div>
<p>Alternatively you can fill using <code class="docutils literal"><span class="pre">ffill</span></code> for forward filling (or also
<code class="docutils literal"><span class="pre">bfill</span></code> for backward filling).</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">flight_rs</span> <span class="o">=</span> <span class="n">flight_sel</span><span class="p">[</span><span class="s1">&#39;Passengers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>
<span class="n">flight_rs</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Date</span>
<span class="mi">2005</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span>    <span class="mi">72928</span>
<span class="mi">2005</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">02</span>    <span class="mi">72928</span>
<span class="mi">2005</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">03</span>    <span class="mi">72928</span>
<span class="mi">2005</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">04</span>    <span class="mi">72928</span>
<span class="mi">2005</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">05</span>    <span class="mi">72928</span>
<span class="n">Freq</span><span class="p">:</span> <span class="n">D</span><span class="p">,</span> <span class="n">Name</span><span class="p">:</span> <span class="n">Passengers</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</pre></div>
</div>
<p>Using forward filling on this dataset does not make much sense because
it implies that each day has the same number of passengers as the month.
It would be better to fill with the monthly average. The interested
reader should attempt to make this type of fill with the simplest code
as possible.</p>
<p>Pandas also has many other very handy tools for datetimes such as</p>
<ul class="simple">
<li>business days</li>
<li>weekdays, holidays</li>
<li>time zones</li>
</ul>
</div>
<div class="section" id="advanced-indexing-in-pandas">
<h3>Advanced Indexing in Pandas<a class="headerlink" href="#advanced-indexing-in-pandas" title="Permalink to this headline">¶</a></h3>
<p>We have already seen the basics of indices and using datetimes, but it
is important to look at indexing in more depth. Indexing is important
because it will allow you to do the following:</p>
<ul class="simple">
<li>intuitively slice and select the dataframe based on the index,</li>
<li>automatically align dataframes by the index,</li>
<li>provide an default variable for visualization and aggregation.</li>
</ul>
<p>We have already seen how to slice and combine dataframes with an index
in Pandas. We also have seen the use of <code class="docutils literal"><span class="pre">set_index</span></code> for setting a
column as an index variable. You can also use multiple columns as
indices, as in</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">flights</span> <span class="o">=</span> <span class="n">flights</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Origin&#39;</span><span class="p">,</span><span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Append does not overwrite Date</span>
<span class="n">flights</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>Dest</th>
      <th>Origin City</th>
      <th>Dest City</th>
      <th>Passengers</th>
      <th>Seats</th>
      <th>Flights</th>
      <th>Distance</th>
      <th>Origin Pop</th>
      <th>Dest Pop</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Origin</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2008-10</th>
      <th>MHK</th>
      <td>AMW</td>
      <td>Manhattan, KS</td>
      <td>Ames, IA</td>
      <td>21</td>
      <td>30</td>
      <td>1</td>
      <td>254.0</td>
      <td>122049</td>
      <td>86219</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">2005-08</th>
      <th>PDX</th>
      <td>RDM</td>
      <td>Portland, OR</td>
      <td>Bend, OR</td>
      <td>5186</td>
      <td>6845</td>
      <td>185</td>
      <td>116.0</td>
      <td>2084053</td>
      <td>140962</td>
    </tr>
    <tr>
      <th>PDX</th>
      <td>RDM</td>
      <td>Portland, OR</td>
      <td>Bend, OR</td>
      <td>2781</td>
      <td>4650</td>
      <td>155</td>
      <td>116.0</td>
      <td>2084053</td>
      <td>140962</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">2005-02</th>
      <th>PDX</th>
      <td>RDM</td>
      <td>Portland, OR</td>
      <td>Bend, OR</td>
      <td>66</td>
      <td>70</td>
      <td>1</td>
      <td>116.0</td>
      <td>2084053</td>
      <td>140962</td>
    </tr>
    <tr>
      <th>PDX</th>
      <td>RDM</td>
      <td>Portland, OR</td>
      <td>Bend, OR</td>
      <td>3791</td>
      <td>5143</td>
      <td>139</td>
      <td>116.0</td>
      <td>2084053</td>
      <td>140962</td>
    </tr>
  </tbody>
</table>
</div><p>You can always undo this operation with the following:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">flights</span> <span class="o">=</span> <span class="n">flights</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">flights</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Origin</th>
      <th>Dest</th>
      <th>Origin City</th>
      <th>Dest City</th>
      <th>Passengers</th>
      <th>Seats</th>
      <th>Flights</th>
      <th>Distance</th>
      <th>Origin Pop</th>
      <th>Dest Pop</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2008-10</td>
      <td>MHK</td>
      <td>AMW</td>
      <td>Manhattan, KS</td>
      <td>Ames, IA</td>
      <td>21</td>
      <td>30</td>
      <td>1</td>
      <td>254.0</td>
      <td>122049</td>
      <td>86219</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2005-08</td>
      <td>PDX</td>
      <td>RDM</td>
      <td>Portland, OR</td>
      <td>Bend, OR</td>
      <td>5186</td>
      <td>6845</td>
      <td>185</td>
      <td>116.0</td>
      <td>2084053</td>
      <td>140962</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2005-08</td>
      <td>PDX</td>
      <td>RDM</td>
      <td>Portland, OR</td>
      <td>Bend, OR</td>
      <td>2781</td>
      <td>4650</td>
      <td>155</td>
      <td>116.0</td>
      <td>2084053</td>
      <td>140962</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2005-02</td>
      <td>PDX</td>
      <td>RDM</td>
      <td>Portland, OR</td>
      <td>Bend, OR</td>
      <td>66</td>
      <td>70</td>
      <td>1</td>
      <td>116.0</td>
      <td>2084053</td>
      <td>140962</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2005-02</td>
      <td>PDX</td>
      <td>RDM</td>
      <td>Portland, OR</td>
      <td>Bend, OR</td>
      <td>3791</td>
      <td>5143</td>
      <td>139</td>
      <td>116.0</td>
      <td>2084053</td>
      <td>140962</td>
    </tr>
  </tbody>
</table>
</div><p>Let&#8217;s set the multi-index again with the following,</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">flights</span> <span class="o">=</span> <span class="n">flights</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span><span class="s1">&#39;Origin&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>You can select elements using <code class="docutils literal"><span class="pre">loc</span></code> with tuples as in the following,</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">flights</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="s1">&#39;2008&#39;</span><span class="p">,</span><span class="s1">&#39;LAX&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">/</span><span class="n">dist</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipykernel_launcher</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span> <span class="n">PerformanceWarning</span><span class="p">:</span> <span class="n">indexing</span> <span class="n">past</span> <span class="n">lexsort</span> <span class="n">depth</span> <span class="n">may</span> <span class="n">impact</span> <span class="n">performance</span><span class="o">.</span>
  <span class="s2">&quot;&quot;&quot;Entry point for launching an IPython kernel.</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>Dest</th>
      <th>Origin City</th>
      <th>Dest City</th>
      <th>Passengers</th>
      <th>Seats</th>
      <th>Flights</th>
      <th>Distance</th>
      <th>Origin Pop</th>
      <th>Dest Pop</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Origin</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">2008-01</th>
      <th>LAX</th>
      <td>RDM</td>
      <td>Los Angeles, CA</td>
      <td>Bend, OR</td>
      <td>2228</td>
      <td>4262</td>
      <td>57</td>
      <td>726.0</td>
      <td>25536790</td>
      <td>157730</td>
    </tr>
    <tr>
      <th>LAX</th>
      <td>RNO</td>
      <td>Los Angeles, CA</td>
      <td>Reno, NV</td>
      <td>1093</td>
      <td>1450</td>
      <td>29</td>
      <td>390.0</td>
      <td>25536790</td>
      <td>416657</td>
    </tr>
    <tr>
      <th>LAX</th>
      <td>RNO</td>
      <td>Los Angeles, CA</td>
      <td>Reno, NV</td>
      <td>67</td>
      <td>132</td>
      <td>2</td>
      <td>390.0</td>
      <td>25536790</td>
      <td>416657</td>
    </tr>
    <tr>
      <th>LAX</th>
      <td>RNO</td>
      <td>Los Angeles, CA</td>
      <td>Reno, NV</td>
      <td>2093</td>
      <td>2950</td>
      <td>59</td>
      <td>390.0</td>
      <td>25536790</td>
      <td>416657</td>
    </tr>
    <tr>
      <th>LAX</th>
      <td>RNO</td>
      <td>Los Angeles, CA</td>
      <td>Reno, NV</td>
      <td>6002</td>
      <td>8696</td>
      <td>116</td>
      <td>390.0</td>
      <td>25536790</td>
      <td>416657</td>
    </tr>
  </tbody>
</table>
</div><p>Why did we get a PerformanceWarning? There is a much bigger story behind
this. Recall that different data structures can optimize look-ups. For
example, the sorted container and dictionaries had very fast loop-ups
because we designed the data structure to make this operation quick.
Pandas sorts the first index by default, which means that selection on
that index is quick. This is because Pandas can use bisection to quickly
find entries. This is not true for the second index, and we have to sort
it as well.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">flights</span> <span class="o">=</span> <span class="n">flights</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<span class="n">flights</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="s1">&#39;2008&#39;</span><span class="p">,</span><span class="s1">&#39;LAX&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>Dest</th>
      <th>Origin City</th>
      <th>Dest City</th>
      <th>Passengers</th>
      <th>Seats</th>
      <th>Flights</th>
      <th>Distance</th>
      <th>Origin Pop</th>
      <th>Dest Pop</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Origin</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">2008-01</th>
      <th>LAX</th>
      <td>RDM</td>
      <td>Los Angeles, CA</td>
      <td>Bend, OR</td>
      <td>2228</td>
      <td>4262</td>
      <td>57</td>
      <td>726.0</td>
      <td>25536790</td>
      <td>157730</td>
    </tr>
    <tr>
      <th>LAX</th>
      <td>RNO</td>
      <td>Los Angeles, CA</td>
      <td>Reno, NV</td>
      <td>1093</td>
      <td>1450</td>
      <td>29</td>
      <td>390.0</td>
      <td>25536790</td>
      <td>416657</td>
    </tr>
    <tr>
      <th>LAX</th>
      <td>RNO</td>
      <td>Los Angeles, CA</td>
      <td>Reno, NV</td>
      <td>67</td>
      <td>132</td>
      <td>2</td>
      <td>390.0</td>
      <td>25536790</td>
      <td>416657</td>
    </tr>
    <tr>
      <th>LAX</th>
      <td>RNO</td>
      <td>Los Angeles, CA</td>
      <td>Reno, NV</td>
      <td>2093</td>
      <td>2950</td>
      <td>59</td>
      <td>390.0</td>
      <td>25536790</td>
      <td>416657</td>
    </tr>
    <tr>
      <th>LAX</th>
      <td>RNO</td>
      <td>Los Angeles, CA</td>
      <td>Reno, NV</td>
      <td>6002</td>
      <td>8696</td>
      <td>116</td>
      <td>390.0</td>
      <td>25536790</td>
      <td>416657</td>
    </tr>
  </tbody>
</table>
</div><p>If you supply only one argument then it will match those to the first
index by default.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">flights</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2008-01&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>Dest</th>
      <th>Origin City</th>
      <th>Dest City</th>
      <th>Passengers</th>
      <th>Seats</th>
      <th>Flights</th>
      <th>Distance</th>
      <th>Origin Pop</th>
      <th>Dest Pop</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Origin</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">2008-01</th>
      <th>ABE</th>
      <td>BOS</td>
      <td>Allentown, PA</td>
      <td>Boston, MA</td>
      <td>0</td>
      <td>57</td>
      <td>10</td>
      <td>258.0</td>
      <td>811669</td>
      <td>9089410</td>
    </tr>
    <tr>
      <th>ABI</th>
      <td>ACT</td>
      <td>Abilene, TX</td>
      <td>Waco, TX</td>
      <td>24</td>
      <td>50</td>
      <td>1</td>
      <td>154.0</td>
      <td>159059</td>
      <td>230849</td>
    </tr>
    <tr>
      <th>ABQ</th>
      <td>RNO</td>
      <td>Albuquerque, NM</td>
      <td>Reno, NV</td>
      <td>118</td>
      <td>150</td>
      <td>1</td>
      <td>787.0</td>
      <td>846582</td>
      <td>416657</td>
    </tr>
    <tr>
      <th>ABQ</th>
      <td>TPA</td>
      <td>Albuquerque, NM</td>
      <td>Tampa, FL</td>
      <td>2973</td>
      <td>4247</td>
      <td>31</td>
      <td>1497.0</td>
      <td>846582</td>
      <td>2730007</td>
    </tr>
    <tr>
      <th>ABQ</th>
      <td>TUL</td>
      <td>Albuquerque, NM</td>
      <td>Tulsa, OK</td>
      <td>661</td>
      <td>1600</td>
      <td>32</td>
      <td>608.0</td>
      <td>846582</td>
      <td>916037</td>
    </tr>
  </tbody>
</table>
</div></div>
<div class="section" id="grouping-aggregating-transforming">
<h3>Grouping, aggregating, transforming<a class="headerlink" href="#grouping-aggregating-transforming" title="Permalink to this headline">¶</a></h3>
<p>We have seen aggregation by downsampling with datetimes. We can break
the aggregation process into <em>group</em> and <em>aggregate</em>. The grouping
specifies the variable to group on, and the DataFrame is then primed to
be aggregated. To do this, we use the <code class="docutils literal"><span class="pre">groupby</span></code> method. We can either
specify a variable name to group by, or specify a level. The level
indicates the level of the multi-index, so <code class="docutils literal"><span class="pre">level=0</span></code> means that we
group by the Date and <code class="docutils literal"><span class="pre">level=1</span></code> means that we group by both Date and
Origin.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">fgb</span> <span class="o">=</span> <span class="n">flights</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">type</span><span class="p">(</span><span class="n">fgb</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">groupby</span><span class="o">.</span><span class="n">groupby</span><span class="o">.</span><span class="n">DataFrameGroupBy</span>
</pre></div>
</div>
<p>This outputs a specific type that is not very useful without another
operation afterwards. After grouping there are a few basic operations
that can do,</p>
<ol class="arabic simple">
<li>Splitting: breaking the DataFrame into multiple DataFrames by
splitting on the groupby variable</li>
<li>Aggregation: reduce the DataFrame to a smaller DataFrame by
aggregating the entries within a group</li>
<li>Transformation: apply a group specific transformation</li>
</ol>
<p>The groupby object is iterable, so it can be used in a for loop. It will
iterate through the groups, for example, the first element of the
sequence is the following tuple:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">fgi</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">fgb</span><span class="p">)</span>
<span class="n">i</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">fgi</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">2005</span><span class="o">-</span><span class="mi">01</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>Dest</th>
      <th>Origin City</th>
      <th>Dest City</th>
      <th>Passengers</th>
      <th>Seats</th>
      <th>Flights</th>
      <th>Distance</th>
      <th>Origin Pop</th>
      <th>Dest Pop</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Origin</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">2005-01</th>
      <th>ABE</th>
      <td>ALB</td>
      <td>Allentown, PA</td>
      <td>Albany, NY</td>
      <td>96</td>
      <td>475</td>
      <td>25</td>
      <td>167.0</td>
      <td>786034</td>
      <td>846357</td>
    </tr>
    <tr>
      <th>ABE</th>
      <td>ALB</td>
      <td>Allentown, PA</td>
      <td>Albany, NY</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>167.0</td>
      <td>786034</td>
      <td>846357</td>
    </tr>
    <tr>
      <th>ABE</th>
      <td>BOS</td>
      <td>Allentown, PA</td>
      <td>Boston, MA</td>
      <td>0</td>
      <td>0</td>
      <td>16</td>
      <td>258.0</td>
      <td>786034</td>
      <td>8917782</td>
    </tr>
    <tr>
      <th>ABE</th>
      <td>BOS</td>
      <td>Allentown, PA</td>
      <td>Boston, MA</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>258.0</td>
      <td>786034</td>
      <td>8917782</td>
    </tr>
    <tr>
      <th>ABI</th>
      <td>EKO</td>
      <td>Abilene, TX</td>
      <td>Elko, NV</td>
      <td>52</td>
      <td>122</td>
      <td>1</td>
      <td>1064.0</td>
      <td>158713</td>
      <td>45801</td>
    </tr>
  </tbody>
</table>
</div><p>this tuple has the index or column value for the group for the first
entry, and the DataFrame of that group as the second entry. We can then
use this groupby object in a for loop.</p>
<p>It is more common to use the groupby operation with aggregation. There
are many methods that do this such as</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">fgb</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Passengers</th>
      <th>Seats</th>
      <th>Flights</th>
      <th>Distance</th>
      <th>Origin Pop</th>
      <th>Dest Pop</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2005-01</th>
      <td>5046686</td>
      <td>7668298</td>
      <td>76997</td>
      <td>1521528.0</td>
      <td>11962365587</td>
      <td>13628265972</td>
    </tr>
    <tr>
      <th>2005-02</th>
      <td>4918624</td>
      <td>7065237</td>
      <td>70211</td>
      <td>1401845.0</td>
      <td>10871394255</td>
      <td>12095147428</td>
    </tr>
    <tr>
      <th>2005-03</th>
      <td>6153200</td>
      <td>7977597</td>
      <td>79428</td>
      <td>1387092.0</td>
      <td>11305919602</td>
      <td>12217493673</td>
    </tr>
    <tr>
      <th>2005-04</th>
      <td>5631513</td>
      <td>7788168</td>
      <td>76576</td>
      <td>1367746.0</td>
      <td>10735150531</td>
      <td>11926205664</td>
    </tr>
    <tr>
      <th>2005-05</th>
      <td>5796881</td>
      <td>7958773</td>
      <td>78806</td>
      <td>1302558.0</td>
      <td>10534055372</td>
      <td>11322419620</td>
    </tr>
  </tbody>
</table>
</div><p>Other than <code class="docutils literal"><span class="pre">sum</span></code> we also have
<code class="docutils literal"><span class="pre">mean,</span> <span class="pre">size,</span> <span class="pre">count,</span> <span class="pre">std,</span> <span class="pre">describe,</span> <span class="pre">min,</span> <span class="pre">max</span></code>.</p>
<p><em>Transformations</em> can be applied column-wise to an entire DataFrame with
the apply method. For example, we can apply the following range based
transformation to all of the variables.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">range_stand</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span>

<span class="n">flights_R</span> <span class="o">=</span> <span class="n">flights</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">range_stand</span><span class="p">)</span>
<span class="n">flights_R</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>Dest</th>
      <th>Origin City</th>
      <th>Dest City</th>
      <th>Passengers</th>
      <th>Seats</th>
      <th>Flights</th>
      <th>Distance</th>
      <th>Origin Pop</th>
      <th>Dest Pop</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Origin</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">2005-01</th>
      <th>ABE</th>
      <td>ALB</td>
      <td>Allentown, PA</td>
      <td>Albany, NY</td>
      <td>0.001577</td>
      <td>0.006627</td>
      <td>0.047438</td>
      <td>0.034348</td>
      <td>0.020272</td>
      <td>0.067561</td>
    </tr>
    <tr>
      <th>ABE</th>
      <td>ALB</td>
      <td>Allentown, PA</td>
      <td>Albany, NY</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.001898</td>
      <td>0.034348</td>
      <td>0.020272</td>
      <td>0.067561</td>
    </tr>
    <tr>
      <th>ABE</th>
      <td>BOS</td>
      <td>Allentown, PA</td>
      <td>Boston, MA</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.030361</td>
      <td>0.053065</td>
      <td>0.020272</td>
      <td>0.723892</td>
    </tr>
    <tr>
      <th>ABE</th>
      <td>BOS</td>
      <td>Allentown, PA</td>
      <td>Boston, MA</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.005693</td>
      <td>0.053065</td>
      <td>0.020272</td>
      <td>0.723892</td>
    </tr>
    <tr>
      <th>ABI</th>
      <td>EKO</td>
      <td>Abilene, TX</td>
      <td>Elko, NV</td>
      <td>0.000854</td>
      <td>0.001702</td>
      <td>0.001898</td>
      <td>0.218840</td>
      <td>0.003818</td>
      <td>0.002464</td>
    </tr>
  </tbody>
</table>
</div><p>This will apply the standardization to the full dataset. Suppose instead
we wanted a group specific transformation. We can use the Groupby object
for this. In introductory statistics courses, we learn about the process
of studentization (a specific standardization). The idea of
studentization is to take a first order statistic and divide it by an
estimate of the standard deviation of this statistic. The Z-score is a
good example of this. Define the following function,</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">Zscore</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

<span class="n">flights_Z</span> <span class="o">=</span> <span class="n">fgb</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">Zscore</span><span class="p">)</span>
</pre></div>
</div>
<p>In order to verify that this actually computed the Z-score we can
compute the group mean and std,</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">flights_Z</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="8" halign="left">Passengers</th>
      <th colspan="2" halign="left">Seats</th>
      <th>...</th>
      <th colspan="2" halign="left">Origin Pop</th>
      <th colspan="8" halign="left">Dest Pop</th>
    </tr>
    <tr>
      <th></th>
      <th>count</th>
      <th>mean</th>
      <th>std</th>
      <th>min</th>
      <th>25%</th>
      <th>50%</th>
      <th>75%</th>
      <th>max</th>
      <th>count</th>
      <th>mean</th>
      <th>...</th>
      <th>75%</th>
      <th>max</th>
      <th>count</th>
      <th>mean</th>
      <th>std</th>
      <th>min</th>
      <th>25%</th>
      <th>50%</th>
      <th>75%</th>
      <th>max</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2005-01</th>
      <td>2171.0</td>
      <td>3.436526e-17</td>
      <td>1.0</td>
      <td>-0.512865</td>
      <td>-0.504482</td>
      <td>-0.418658</td>
      <td>0.081281</td>
      <td>8.986194</td>
      <td>2171.0</td>
      <td>-6.545764e-18</td>
      <td>...</td>
      <td>-0.008587</td>
      <td>4.117544</td>
      <td>2171.0</td>
      <td>-7.363985e-17</td>
      <td>1.0</td>
      <td>-1.270299</td>
      <td>-1.101795</td>
      <td>0.535650</td>
      <td>1.086447</td>
      <td>1.086447</td>
    </tr>
    <tr>
      <th>2005-02</th>
      <td>1940.0</td>
      <td>-1.098777e-17</td>
      <td>1.0</td>
      <td>-0.546320</td>
      <td>-0.535977</td>
      <td>-0.418325</td>
      <td>0.086327</td>
      <td>8.430323</td>
      <td>1940.0</td>
      <td>7.325183e-18</td>
      <td>...</td>
      <td>0.343680</td>
      <td>4.079229</td>
      <td>1940.0</td>
      <td>-4.303545e-17</td>
      <td>1.0</td>
      <td>-1.267042</td>
      <td>-1.097813</td>
      <td>0.546674</td>
      <td>1.099840</td>
      <td>1.099840</td>
    </tr>
    <tr>
      <th>2005-03</th>
      <td>1958.0</td>
      <td>1.088676e-17</td>
      <td>1.0</td>
      <td>-0.547159</td>
      <td>-0.539977</td>
      <td>-0.438775</td>
      <td>0.084819</td>
      <td>8.516516</td>
      <td>1958.0</td>
      <td>-2.268076e-17</td>
      <td>...</td>
      <td>0.313345</td>
      <td>3.949029</td>
      <td>1958.0</td>
      <td>-9.072303e-17</td>
      <td>1.0</td>
      <td>-1.273532</td>
      <td>-1.103577</td>
      <td>0.547960</td>
      <td>1.103497</td>
      <td>1.103497</td>
    </tr>
    <tr>
      <th>2005-04</th>
      <td>1908.0</td>
      <td>5.120525e-17</td>
      <td>1.0</td>
      <td>-0.527864</td>
      <td>-0.516820</td>
      <td>-0.426728</td>
      <td>0.074976</td>
      <td>8.233367</td>
      <td>1908.0</td>
      <td>9.310046e-18</td>
      <td>...</td>
      <td>0.099313</td>
      <td>4.078980</td>
      <td>1908.0</td>
      <td>3.351617e-17</td>
      <td>1.0</td>
      <td>-1.271101</td>
      <td>-1.101767</td>
      <td>0.543750</td>
      <td>1.097262</td>
      <td>1.097262</td>
    </tr>
    <tr>
      <th>2005-05</th>
      <td>1835.0</td>
      <td>2.516909e-17</td>
      <td>1.0</td>
      <td>-0.536164</td>
      <td>-0.526829</td>
      <td>-0.441798</td>
      <td>0.095119</td>
      <td>8.081325</td>
      <td>1835.0</td>
      <td>0.000000e+00</td>
      <td>...</td>
      <td>0.322567</td>
      <td>4.016117</td>
      <td>1835.0</td>
      <td>2.904126e-18</td>
      <td>1.0</td>
      <td>-1.249219</td>
      <td>-1.080626</td>
      <td>0.557683</td>
      <td>1.108771</td>
      <td>1.108771</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 48 columns</p>
</div></div>
<div class="section" id="concatenating-and-joining-dataframes">
<h3>Concatenating and joining DataFrames<a class="headerlink" href="#concatenating-and-joining-dataframes" title="Permalink to this headline">¶</a></h3>
<p>We have already seen how indexing can be used to add two DataFrames or
Series together. The idea is that two elements get added together if
they have the same index. Of course, there are other ways to combine
DataFrames, particularly concatenating and joining. The simple rule is
for joining datasets with the same or similar columns by stacking them
you want to concatenate; if you want to combine datasets with different
columns by matching indices then you want to join.</p>
<p>At the beginning of the section, we worked with only the first chunk of
the data. Suppose that we want to just read in the the data with a
certain destination airport and sum the passengers, flights, and seats
that arrive there. I will create an iterator with the following method.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_proc_flights</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span><span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;../data/flight_red.tsv&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;iterator that runs through the flight data&quot;&quot;&quot;</span>
    <span class="n">flights_it</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">chunksize</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">colnames</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">flights</span> <span class="ow">in</span> <span class="n">flights_it</span><span class="p">:</span>
        <span class="n">flights</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">flights</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">],</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y%m&#39;</span><span class="p">)</span> <span class="c1"># process Date</span>
        <span class="n">flights</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">PeriodIndex</span><span class="p">(</span><span class="n">flights</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">],</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>
        <span class="n">flights</span> <span class="o">=</span> <span class="n">flights</span><span class="p">[</span><span class="n">flights</span><span class="p">[</span><span class="s1">&#39;Dest&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">dest</span><span class="p">]</span> <span class="c1"># filter by destination</span>
        <span class="n">flights</span> <span class="o">=</span> <span class="n">flights</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span><span class="s1">&#39;Origin&#39;</span><span class="p">])</span> <span class="c1"># will group by Origin and Date</span>
        <span class="n">flights</span> <span class="o">=</span> <span class="n">flights</span><span class="p">[</span><span class="n">colnames</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">7</span><span class="p">]]</span> <span class="c1"># select just Pass, Seats, Flights</span>
        <span class="k">yield</span> <span class="n">flights</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1"># sum within Origin and Date</span>
</pre></div>
</div>
<p>Then we can use this iterator to read in the data and add it
sequentially,</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">read_dest</span><span class="p">(</span><span class="n">dest</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;read the flight data to a destination&quot;&quot;&quot;</span>
    <span class="n">pf</span> <span class="o">=</span> <span class="n">_proc_flights</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
    <span class="n">flights</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">pf</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">pf</span><span class="p">:</span>
        <span class="n">flights</span> <span class="o">=</span> <span class="n">flights</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">flights</span>
</pre></div>
</div>
<p>Because these processes above can take some time, it is best practice to put them in a module and run them in the background in the command line.</p>
<p>Let&#8217;s apply this to the BOS and DFW airports,</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">BOS</span> <span class="o">=</span> <span class="n">read_dest</span><span class="p">(</span><span class="s1">&#39;BOS&#39;</span><span class="p">)</span>
<span class="n">BOS</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>Passengers</th>
      <th>Seats</th>
      <th>Flights</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Origin</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">2005-01</th>
      <th>ABE</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>19.0</td>
    </tr>
    <tr>
      <th>ALB</th>
      <td>507.0</td>
      <td>1436.0</td>
      <td>73.0</td>
    </tr>
    <tr>
      <th>ATL</th>
      <td>52226.0</td>
      <td>73879.0</td>
      <td>436.0</td>
    </tr>
    <tr>
      <th>AUG</th>
      <td>250.0</td>
      <td>1672.0</td>
      <td>88.0</td>
    </tr>
    <tr>
      <th>BDL</th>
      <td>770.0</td>
      <td>1292.0</td>
      <td>10.0</td>
    </tr>
  </tbody>
</table>
</div><div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">DFW</span> <span class="o">=</span> <span class="n">read_dest</span><span class="p">(</span><span class="s1">&#39;DFW&#39;</span><span class="p">)</span>
<span class="n">DFW</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>Passengers</th>
      <th>Seats</th>
      <th>Flights</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Origin</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">2005-01</th>
      <th>ABI</th>
      <td>4161.0</td>
      <td>7146.0</td>
      <td>173.0</td>
    </tr>
    <tr>
      <th>ABQ</th>
      <td>22671.0</td>
      <td>36362.0</td>
      <td>333.0</td>
    </tr>
    <tr>
      <th>ACT</th>
      <td>3946.0</td>
      <td>6430.0</td>
      <td>182.0</td>
    </tr>
    <tr>
      <th>AEX</th>
      <td>1017.0</td>
      <td>2580.0</td>
      <td>57.0</td>
    </tr>
    <tr>
      <th>AFW</th>
      <td>92.0</td>
      <td>180.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div><p>An example of concatenation is the following, which you can think of as
stacking the DataFrames on top of one another.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">pieces</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;BOS&#39;</span><span class="p">:</span><span class="n">BOS</span><span class="p">,</span> <span class="s1">&#39;DFW&#39;</span><span class="p">:</span><span class="n">DFW</span><span class="p">}</span>
<span class="n">BDcon</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">pieces</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">BDcon</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th></th>
      <th>Passengers</th>
      <th>Seats</th>
      <th>Flights</th>
    </tr>
    <tr>
      <th></th>
      <th>Date</th>
      <th>Origin</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">BOS</th>
      <th rowspan="5" valign="top">2005-01</th>
      <th>ABE</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>19.0</td>
    </tr>
    <tr>
      <th>ALB</th>
      <td>507.0</td>
      <td>1436.0</td>
      <td>73.0</td>
    </tr>
    <tr>
      <th>ATL</th>
      <td>52226.0</td>
      <td>73879.0</td>
      <td>436.0</td>
    </tr>
    <tr>
      <th>AUG</th>
      <td>250.0</td>
      <td>1672.0</td>
      <td>88.0</td>
    </tr>
    <tr>
      <th>BDL</th>
      <td>770.0</td>
      <td>1292.0</td>
      <td>10.0</td>
    </tr>
  </tbody>
</table>
</div><p>The above code added an additional index at level 0 that specifies which
DataFrame that the record is from. The keys for this index were supplied
as the keys in the dictionary <code class="docutils literal"><span class="pre">pieces</span></code>. We could also have supplied
this using the <code class="docutils literal"><span class="pre">keys</span></code> argument in <code class="docutils literal"><span class="pre">concat</span></code> and instead passed a list
of the dictionaries.</p>
<p>Joining is another way to combine DataFrames. We will return to the
concept of joins tables in more detail when we talk about relational
databases in Unit 2. The basic idea is that we match the entries of one
dataframe to another by their indices. Throughout let&#8217;s assume that the
DataFrames in question have unique indices as above.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">BDjoin</span> <span class="o">=</span> <span class="n">BOS</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DFW</span><span class="p">,</span><span class="n">lsuffix</span><span class="o">=</span><span class="s1">&#39;_DFW&#39;</span><span class="p">,</span><span class="n">rsuffix</span><span class="o">=</span><span class="s1">&#39;_BOS&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">BDjoin</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">BOS</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">BDjoin</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">4027</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="p">(</span><span class="mi">4027</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>Passengers_DFW</th>
      <th>Seats_DFW</th>
      <th>Flights_DFW</th>
      <th>Passengers_BOS</th>
      <th>Seats_BOS</th>
      <th>Flights_BOS</th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Origin</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">2005-01</th>
      <th>ABE</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>19.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>ALB</th>
      <td>507.0</td>
      <td>1436.0</td>
      <td>73.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>ATL</th>
      <td>52226.0</td>
      <td>73879.0</td>
      <td>436.0</td>
      <td>91441.0</td>
      <td>131566.0</td>
      <td>985.0</td>
    </tr>
    <tr>
      <th>AUG</th>
      <td>250.0</td>
      <td>1672.0</td>
      <td>88.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>BDL</th>
      <td>770.0</td>
      <td>1292.0</td>
      <td>10.0</td>
      <td>9251.0</td>
      <td>11875.0</td>
      <td>92.0</td>
    </tr>
  </tbody>
</table>
</div><p>Six variables were created in this new DataFrame with names that are the
variable names and the specified suffices appended to the column names.
We see that the join will take each index on the first DataFrame (called
the left table) and try to find an entry in the second DataFrame (called
the right table) and append those variables to the row, with NaNs
entered when there is no match. This is called a left join. The types of
join are,</p>
<ul class="simple">
<li><em>left join:</em> the rows in the left table are preserved, and matched to
rows in the right table with NaNs when there is no match.</li>
<li><em>right join:</em> the rows in the right table are preserved, and matched
to rows in the left table with NaNs when there is no match.</li>
<li><em>inner join:</em> the rows in the left and right tables are matched and
the row is omitted if there is no match (this intersects the two
tables indices).</li>
<li><em>outer join:</em> the rows in the left and right table are matched,
either table&#8217;s variables are filled with NaNs when there is no match
(this unions the two tables indices).</li>
</ul>
<p>You can specify the way that we join the two tables with the <code class="docutils literal"><span class="pre">how</span></code>
argument, which is <code class="docutils literal"><span class="pre">&quot;left&quot;</span></code> by default.</p>
</div>
</div>
<div class="section" id="missingness">
<h2>Missingness<a class="headerlink" href="#missingness" title="Permalink to this headline">¶</a></h2>
<p>Missing data is one of the most common unforeseen issues in data
analysis. In a prediction problem, we can deal with missing predictor
variables by engineering features that are missingness-aware. In this
case, simple imputation methods may suffice. When a variable of interest
is missing, such as the response variable in prediction, these same
imputation methods may lead us to some strange conclusions. First, let&#8217;s
go over some basics of missing data.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
</pre></div>
</div>
<p>Let&#8217;s begin our discussion of the different types of missing by
simulating a dataset with missingness. In the following, we have a
dataset with two variable where each entry of the first is not missing
with probability .84 and is missing otherwise. The second variable is
non-missing.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="o">.</span><span class="mi">84</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,(</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">.</span><span class="mi">84</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
<span class="n">X</span><span class="p">[</span><span class="n">M</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="c1"># X0 is not missing with prob .84</span>
<span class="n">X_MCAR</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">X_MCAR</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.327573</td>
      <td>-2.403688</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-0.549736</td>
      <td>-0.537814</td>
    </tr>
    <tr>
      <th>2</th>
      <td>NaN</td>
      <td>-0.169579</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.047577</td>
      <td>-0.013752</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.808157</td>
      <td>0.234873</td>
    </tr>
  </tbody>
</table>
</div><p>We can see that a missing value is encoded as a NaN in the DataFrame.
The missing value may be encoded differently depending on the column
type (datetimes encode missingness as NaT for example). For numerical
types this is <code class="docutils literal"><span class="pre">np.nan</span></code>.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">X_MCAR</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>170.000000</td>
      <td>200.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>-0.176160</td>
      <td>-0.055610</td>
    </tr>
    <tr>
      <th>std</th>
      <td>1.019463</td>
      <td>0.949872</td>
    </tr>
    <tr>
      <th>min</th>
      <td>-2.460313</td>
      <td>-2.403688</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>-0.919884</td>
      <td>-0.616639</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>-0.242606</td>
      <td>-0.046619</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>0.515983</td>
      <td>0.634754</td>
    </tr>
    <tr>
      <th>max</th>
      <td>2.886748</td>
      <td>2.643257</td>
    </tr>
  </tbody>
</table>
</div><p>We can see that there are many missing values because the <code class="docutils literal"><span class="pre">count</span></code> is
smaller in X0. All of statistics in the <code class="docutils literal"><span class="pre">describe</span></code> function other than
<code class="docutils literal"><span class="pre">count</span></code> are computed with the missingness ignored. Typically, Pandas
ignores missingness by default when computing statistics and making
plots. We can expect that because the missingness is done randomly and
independently of the other variables then these statistics are unbiased
for the population statistics (if there was no missingness).</p>
<p><strong>Def.</strong> When a variable is missing independently and at random, and the
missingness status is not dependent on any observed value, we say the
variable is <em>missing completely at random (MCAR)</em>. In this case variable
X0 is MCAR because the missingness is not dependent on X1.</p>
<p>Let&#8217;s simulate from a model where the missingness is dependent on the
second variable, X1.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,(</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">X</span><span class="p">[</span><span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="c1"># X0 is missing if X1 &gt; 1</span>
<span class="n">X_MAR</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">X_MAR</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>172.000000</td>
      <td>200.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>0.007135</td>
      <td>-0.012531</td>
    </tr>
    <tr>
      <th>std</th>
      <td>1.027917</td>
      <td>0.961955</td>
    </tr>
    <tr>
      <th>min</th>
      <td>-2.497748</td>
      <td>-2.568347</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>-0.744684</td>
      <td>-0.557767</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>-0.100491</td>
      <td>0.030946</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>0.622769</td>
      <td>0.551149</td>
    </tr>
    <tr>
      <th>max</th>
      <td>2.509379</td>
      <td>3.018901</td>
    </tr>
  </tbody>
</table>
</div><p>We can see that <code class="docutils literal"><span class="pre">count</span></code> is similar and none of the statistics for
variable X0 have significantly changed. This is because X1 was drawn
independently from X0, and so the missingness mechanism is also
independent from X0. We will return to this dataset.</p>
<p><strong>Def.</strong> When a variable is missing independently and at random, but the
missingness status is dependent on another observed variable, we say the
variable is <em>missing at random (MAR)</em>. In the case above, X0 is MAR
because the missingness is dependent on X1 but not explicitely on X0.</p>
<p>Let&#8217;s simulate from another model where the missingness of X0 is
dependent on its value.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,(</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">X</span><span class="p">[</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="c1"># X0 is missing if X0 &gt; 1</span>
<span class="n">X_MNAR</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">X_MNAR</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>167.000000</td>
      <td>200.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>-0.270645</td>
      <td>-0.050537</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.816188</td>
      <td>0.972811</td>
    </tr>
    <tr>
      <th>min</th>
      <td>-2.974269</td>
      <td>-2.888389</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>-0.884813</td>
      <td>-0.690774</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>-0.151122</td>
      <td>-0.065065</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>0.310640</td>
      <td>0.704453</td>
    </tr>
    <tr>
      <th>max</th>
      <td>0.993096</td>
      <td>1.992330</td>
    </tr>
  </tbody>
</table>
</div><p>We see that <code class="docutils literal"><span class="pre">count</span></code> is again similar to the previous statistics, but
the other statistics have changed dramatically. The mean is brought down
because we made the large values of X0 be missing, and this has likewise
reduced the <code class="docutils literal"><span class="pre">max</span></code> which is concentrating around 1.</p>
<p><strong>Def.</strong> When a variable&#8217;s missingness remains dependent on its latent
value, even after conditioning on other observed values, this is called
<em>missing not at random (MNAR)</em>. This happens when the missingness is
neither MAR or MCAR.</p>
<div class="section" id="looking-at-missingness-in-pandas">
<h3>Looking at missingness in Pandas<a class="headerlink" href="#looking-at-missingness-in-pandas" title="Permalink to this headline">¶</a></h3>
<p>There is typically not much we can do about MNAR data if the missing
variable is of interest. On the other hand, we can sometimes guess at
the missingness mechanism. For example, if we had looked at the
histograms of the data,</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">X_MNAR</span><span class="o">.</span><span class="n">hist</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/missingness_12_0.png" src="../_images/missingness_12_0.png" />
<p>we might notice that variable X0 has a cliff at 1. We may correctly
suspect that all values above 1 were cencored.</p>
<p>How might we distinguish between the <code class="docutils literal"><span class="pre">X_MAR</span></code> and the <code class="docutils literal"><span class="pre">X_MCAR</span></code>
datasets if we did not already know how they were simulated? In Pandas,
we can test which entries are missing with <code class="docutils literal"><span class="pre">isna,</span> <span class="pre">notna</span></code>.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">X_MCAR</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>3</th>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>4</th>
      <td>False</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div><p>This converted all of the entries to the True/False answer to &#8220;is this
value missing?&#8221;. This is the preferred way to evaluate missingness
because in Python <code class="docutils literal"><span class="pre">np.nan</span> <span class="pre">==</span> <span class="pre">np.nan</span></code> actually evaluates to False, so
testing with expressions of this type doesn&#8217;t work.</p>
<p>You should think of the result of <code class="docutils literal"><span class="pre">isna</span></code> as another variable that you
may want to include in your analysis. In prediction tasks we will often
include these variables when we do feature engineering, as we will see
later. For our purposes, we can see the difference between the <code class="docutils literal"><span class="pre">X_MAR</span></code>
and <code class="docutils literal"><span class="pre">X_MCAR</span></code> data with this missingness indicator included.
Specifically, we want to see what the dependence is between the
missingness and other variables. We can do this by grouping by the
missingness and describing the other variable. The following function
adds the missingness indicator to a dataset for a variable, removes that
variable, groups by the missingness, and describes the remaining
variables.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">desc_missing</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">missingvar</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Describes the variables conditioned on the missingness&quot;&quot;&quot;</span>
    <span class="n">X_mod</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">X_mod</span><span class="p">[</span><span class="s1">&#39;miss_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_mod</span><span class="p">[</span><span class="n">missingvar</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
    <span class="k">del</span> <span class="n">X_mod</span><span class="p">[</span><span class="n">missingvar</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">X_mod</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;miss_ind&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">desc_missing</span><span class="p">(</span><span class="n">X_MCAR</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="8" halign="left">1</th>
    </tr>
    <tr>
      <th></th>
      <th>count</th>
      <th>mean</th>
      <th>std</th>
      <th>min</th>
      <th>25%</th>
      <th>50%</th>
      <th>75%</th>
      <th>max</th>
    </tr>
    <tr>
      <th>miss_ind</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>False</th>
      <td>170.0</td>
      <td>-0.059364</td>
      <td>0.939388</td>
      <td>-2.403688</td>
      <td>-0.577253</td>
      <td>-0.046619</td>
      <td>0.575143</td>
      <td>2.643257</td>
    </tr>
    <tr>
      <th>True</th>
      <td>30.0</td>
      <td>-0.034340</td>
      <td>1.023837</td>
      <td>-2.152632</td>
      <td>-0.632773</td>
      <td>0.029868</td>
      <td>0.724111</td>
      <td>1.795847</td>
    </tr>
  </tbody>
</table>
</div><div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">desc_missing</span><span class="p">(</span><span class="n">X_MAR</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="8" halign="left">1</th>
    </tr>
    <tr>
      <th></th>
      <th>count</th>
      <th>mean</th>
      <th>std</th>
      <th>min</th>
      <th>25%</th>
      <th>50%</th>
      <th>75%</th>
      <th>max</th>
    </tr>
    <tr>
      <th>miss_ind</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>False</th>
      <td>172.0</td>
      <td>-0.255640</td>
      <td>0.790491</td>
      <td>-2.568347</td>
      <td>-0.695704</td>
      <td>-0.102948</td>
      <td>0.379905</td>
      <td>0.982192</td>
    </tr>
    <tr>
      <th>True</th>
      <td>28.0</td>
      <td>1.480858</td>
      <td>0.416369</td>
      <td>1.069409</td>
      <td>1.218558</td>
      <td>1.365086</td>
      <td>1.586109</td>
      <td>3.018901</td>
    </tr>
  </tbody>
</table>
</div><p>In the above displays, we see that for the MCAR dataset there is little
difference between the summary statistics for X1 when X0 is missing or
not. For the MAR dataset, there is a more pronounced difference between
the means of these two subsets of the data. This is one indication to us
that <code class="docutils literal"><span class="pre">X_MAR</span></code> is not MCAR.</p>
<p>We could also do this formally with a T-test for difference in means
between two samples. I will assume that you
recall the T-test for independence from your introductory statistics
course, if not please review it before trying to parse the following
code blocks.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_MCAR</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">missingvar</span><span class="p">,</span><span class="n">testvar</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test if testvar is independent of missingness</span>
<span class="sd">    Uses two-sided t-test with pooled variances</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">X_mod</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">X_mod</span><span class="p">[</span><span class="s1">&#39;miss_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_mod</span><span class="p">[</span><span class="n">missingvar</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
    <span class="k">del</span> <span class="n">X_mod</span><span class="p">[</span><span class="n">missingvar</span><span class="p">]</span>
    <span class="n">X1</span><span class="p">,</span><span class="n">X2</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="n">X_mod</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;miss_ind&#39;</span><span class="p">)]</span> <span class="c1">#split</span>
    <span class="k">return</span> <span class="n">sm</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="n">testvar</span><span class="p">],</span><span class="n">X2</span><span class="p">[</span><span class="n">testvar</span><span class="p">])</span> <span class="c1">#return test</span>
</pre></div>
</div>
<p>In the above function we split the grouped dataframe based on the
missingness status. We used the <code class="docutils literal"><span class="pre">ttest_ind</span></code> method in statsmodels to
perform the two-sample t-test with pooled variances. The resulting
P-values are below:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;X_MCAR P-value: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_MCAR</span><span class="p">(</span><span class="n">X_MCAR</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;X_MAR P-value: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_MCAR</span><span class="p">(</span><span class="n">X_MAR</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">X_MCAR</span> <span class="n">P</span><span class="o">-</span><span class="n">value</span><span class="p">:</span> <span class="mf">0.8945613701172417</span>
<span class="n">X_MAR</span> <span class="n">P</span><span class="o">-</span><span class="n">value</span><span class="p">:</span> <span class="mf">2.4792949402817898e-23</span>
</pre></div>
</div>
<p>This provides more satisfying evidence that the dataset <code class="docutils literal"><span class="pre">X_MAR</span></code> is not
drawn MCAR.</p>
</div>
<div class="section" id="dealing-with-missingness-and-simple-imputation">
<h3>Dealing with missingness and simple imputation<a class="headerlink" href="#dealing-with-missingness-and-simple-imputation" title="Permalink to this headline">¶</a></h3>
<p>Imputation is the process of filling in missing values. There are few
great options when it comes to imputation, and very few general purpose
tools that will perfectly impute missing data. Let&#8217;s discuss some
reasonable simple options and their limitations.</p>
<p>Let&#8217;s begin by loading in the Melbourne housing dataset, which is from
the Kaggle competitions:
<a class="reference external" href="https://www.kaggle.com/anthonypino/melbourne-housing-market/version/26">https://www.kaggle.com/anthonypino/melbourne-housing-market/version/26</a>
The dataset describes home sales in Melborne, Australia.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mel</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/Melbourne_housing_FULL.csv&#39;</span><span class="p">)</span>
<span class="n">mel</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Suburb</th>
      <th>Address</th>
      <th>Rooms</th>
      <th>Type</th>
      <th>Price</th>
      <th>Method</th>
      <th>SellerG</th>
      <th>Date</th>
      <th>Distance</th>
      <th>Postcode</th>
      <th>...</th>
      <th>Bathroom</th>
      <th>Car</th>
      <th>Landsize</th>
      <th>BuildingArea</th>
      <th>YearBuilt</th>
      <th>CouncilArea</th>
      <th>Lattitude</th>
      <th>Longtitude</th>
      <th>Regionname</th>
      <th>Propertycount</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Abbotsford</td>
      <td>68 Studley St</td>
      <td>2</td>
      <td>h</td>
      <td>NaN</td>
      <td>SS</td>
      <td>Jellis</td>
      <td>3/09/2016</td>
      <td>2.5</td>
      <td>3067.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>126.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Yarra City Council</td>
      <td>-37.8014</td>
      <td>144.9958</td>
      <td>Northern Metropolitan</td>
      <td>4019.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Abbotsford</td>
      <td>85 Turner St</td>
      <td>2</td>
      <td>h</td>
      <td>1480000.0</td>
      <td>S</td>
      <td>Biggin</td>
      <td>3/12/2016</td>
      <td>2.5</td>
      <td>3067.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>202.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Yarra City Council</td>
      <td>-37.7996</td>
      <td>144.9984</td>
      <td>Northern Metropolitan</td>
      <td>4019.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Abbotsford</td>
      <td>25 Bloomburg St</td>
      <td>2</td>
      <td>h</td>
      <td>1035000.0</td>
      <td>S</td>
      <td>Biggin</td>
      <td>4/02/2016</td>
      <td>2.5</td>
      <td>3067.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>156.0</td>
      <td>79.0</td>
      <td>1900.0</td>
      <td>Yarra City Council</td>
      <td>-37.8079</td>
      <td>144.9934</td>
      <td>Northern Metropolitan</td>
      <td>4019.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Abbotsford</td>
      <td>18/659 Victoria St</td>
      <td>3</td>
      <td>u</td>
      <td>NaN</td>
      <td>VB</td>
      <td>Rounds</td>
      <td>4/02/2016</td>
      <td>2.5</td>
      <td>3067.0</td>
      <td>...</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Yarra City Council</td>
      <td>-37.8114</td>
      <td>145.0116</td>
      <td>Northern Metropolitan</td>
      <td>4019.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Abbotsford</td>
      <td>5 Charles St</td>
      <td>3</td>
      <td>h</td>
      <td>1465000.0</td>
      <td>SP</td>
      <td>Biggin</td>
      <td>4/03/2017</td>
      <td>2.5</td>
      <td>3067.0</td>
      <td>...</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>134.0</td>
      <td>150.0</td>
      <td>1900.0</td>
      <td>Yarra City Council</td>
      <td>-37.8093</td>
      <td>144.9944</td>
      <td>Northern Metropolitan</td>
      <td>4019.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 21 columns</p>
</div><div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mel</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 34857 entries, 0 to 34856
Data columns (total 21 columns):
Suburb           34857 non-null object
Address          34857 non-null object
Rooms            34857 non-null int64
Type             34857 non-null object
Price            27247 non-null float64
Method           34857 non-null object
SellerG          34857 non-null object
Date             34857 non-null object
Distance         34856 non-null float64
Postcode         34856 non-null float64
Bedroom2         26640 non-null float64
Bathroom         26631 non-null float64
Car              26129 non-null float64
Landsize         23047 non-null float64
BuildingArea     13742 non-null float64
YearBuilt        15551 non-null float64
CouncilArea      34854 non-null object
Lattitude        26881 non-null float64
Longtitude       26881 non-null float64
Regionname       34854 non-null object
Propertycount    34854 non-null float64
dtypes: float64(12), int64(1), object(8)
memory usage: 5.6+ MB
</pre></div>
</div>
<p>From the info we can see that there is significant missingness in many
of these variables. While we would like to impute as many of these
values as possible, we are especially interested in imputing the Price
of the home. Before we proceed with this, we can notice that Date and
YearBuilt columns are not datetimes, so we should convert these first.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mel</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">][:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">0</span>    <span class="mi">3</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">2016</span>
<span class="mi">1</span>    <span class="mi">3</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">2016</span>
<span class="mi">2</span>    <span class="mi">4</span><span class="o">/</span><span class="mi">02</span><span class="o">/</span><span class="mi">2016</span>
<span class="mi">3</span>    <span class="mi">4</span><span class="o">/</span><span class="mi">02</span><span class="o">/</span><span class="mi">2016</span>
<span class="mi">4</span>    <span class="mi">4</span><span class="o">/</span><span class="mi">03</span><span class="o">/</span><span class="mi">2017</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">Date</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">object</span>
</pre></div>
</div>
<p>Looking at the Date, we can see that the string is in a standard date
format, and we can then cast as a datetime.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mel</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">mel</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">],</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The Yearbuilt variable is a bit more challenging, since it was cast as a
float.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mel</span><span class="p">[</span><span class="s1">&#39;YearBuilt&#39;</span><span class="p">][:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">0</span>       <span class="n">NaN</span>
<span class="mi">1</span>       <span class="n">NaN</span>
<span class="mi">2</span>    <span class="mf">1900.0</span>
<span class="mi">3</span>       <span class="n">NaN</span>
<span class="mi">4</span>    <span class="mf">1900.0</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">YearBuilt</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</pre></div>
</div>
<p>Let&#8217;s write a custom function that converts the float first to integer,
then to string, if it is not NaN.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">conv_year</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
</pre></div>
</div>
<p>We apply this using the <code class="docutils literal"><span class="pre">apply</span></code> method, then convert to a PeriodIndex
object.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mel</span><span class="p">[</span><span class="s1">&#39;YearBuilt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mel</span><span class="p">[</span><span class="s1">&#39;YearBuilt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">conv_year</span><span class="p">)</span>
<span class="n">mel</span><span class="p">[</span><span class="s1">&#39;YearBuilt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">PeriodIndex</span><span class="p">(</span><span class="n">mel</span><span class="p">[</span><span class="s1">&#39;YearBuilt&#39;</span><span class="p">],</span><span class="n">freq</span><span class="o">=</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>We can verify that this is the desired result.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mel</span><span class="p">[</span><span class="s1">&#39;YearBuilt&#39;</span><span class="p">][:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">0</span>    <span class="n">NaT</span>
<span class="mi">1</span>    <span class="n">NaT</span>
<span class="mi">2</span>   <span class="mi">1900</span>
<span class="mi">3</span>    <span class="n">NaT</span>
<span class="mi">4</span>   <span class="mi">1900</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">YearBuilt</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">object</span>
</pre></div>
</div>
<p>We have seen the use of <code class="docutils literal"><span class="pre">isna</span></code> to make a missingness indicator
variable. We can easily do this to all of the variables and add
missingness indicators for all of them using a join.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mel_miss</span> <span class="o">=</span> <span class="n">mel</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
<span class="n">mel</span> <span class="o">=</span> <span class="n">mel</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mel_miss</span><span class="p">,</span><span class="n">rsuffix</span><span class="o">=</span><span class="s2">&quot;_miss&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now <code class="docutils literal"><span class="pre">mel</span></code> has twice the number of columns.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mel</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Index</span><span class="p">([</span><span class="s1">&#39;Suburb&#39;</span><span class="p">,</span> <span class="s1">&#39;Address&#39;</span><span class="p">,</span> <span class="s1">&#39;Rooms&#39;</span><span class="p">,</span> <span class="s1">&#39;Type&#39;</span><span class="p">,</span> <span class="s1">&#39;Price&#39;</span><span class="p">,</span> <span class="s1">&#39;Method&#39;</span><span class="p">,</span> <span class="s1">&#39;SellerG&#39;</span><span class="p">,</span>
       <span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">,</span> <span class="s1">&#39;Postcode&#39;</span><span class="p">,</span> <span class="s1">&#39;Bedroom2&#39;</span><span class="p">,</span> <span class="s1">&#39;Bathroom&#39;</span><span class="p">,</span> <span class="s1">&#39;Car&#39;</span><span class="p">,</span>
       <span class="s1">&#39;Landsize&#39;</span><span class="p">,</span> <span class="s1">&#39;BuildingArea&#39;</span><span class="p">,</span> <span class="s1">&#39;YearBuilt&#39;</span><span class="p">,</span> <span class="s1">&#39;CouncilArea&#39;</span><span class="p">,</span> <span class="s1">&#39;Lattitude&#39;</span><span class="p">,</span>
       <span class="s1">&#39;Longtitude&#39;</span><span class="p">,</span> <span class="s1">&#39;Regionname&#39;</span><span class="p">,</span> <span class="s1">&#39;Propertycount&#39;</span><span class="p">,</span> <span class="s1">&#39;Suburb_miss&#39;</span><span class="p">,</span>
       <span class="s1">&#39;Address_miss&#39;</span><span class="p">,</span> <span class="s1">&#39;Rooms_miss&#39;</span><span class="p">,</span> <span class="s1">&#39;Type_miss&#39;</span><span class="p">,</span> <span class="s1">&#39;Price_miss&#39;</span><span class="p">,</span> <span class="s1">&#39;Method_miss&#39;</span><span class="p">,</span>
       <span class="s1">&#39;SellerG_miss&#39;</span><span class="p">,</span> <span class="s1">&#39;Date_miss&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance_miss&#39;</span><span class="p">,</span> <span class="s1">&#39;Postcode_miss&#39;</span><span class="p">,</span>
       <span class="s1">&#39;Bedroom2_miss&#39;</span><span class="p">,</span> <span class="s1">&#39;Bathroom_miss&#39;</span><span class="p">,</span> <span class="s1">&#39;Car_miss&#39;</span><span class="p">,</span> <span class="s1">&#39;Landsize_miss&#39;</span><span class="p">,</span>
       <span class="s1">&#39;BuildingArea_miss&#39;</span><span class="p">,</span> <span class="s1">&#39;YearBuilt_miss&#39;</span><span class="p">,</span> <span class="s1">&#39;CouncilArea_miss&#39;</span><span class="p">,</span>
       <span class="s1">&#39;Lattitude_miss&#39;</span><span class="p">,</span> <span class="s1">&#39;Longtitude_miss&#39;</span><span class="p">,</span> <span class="s1">&#39;Regionname_miss&#39;</span><span class="p">,</span>
       <span class="s1">&#39;Propertycount_miss&#39;</span><span class="p">],</span>
      <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;object&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The simplest form of imputation is to replace the missing values in a
column with a single value. This can be accomplished with <code class="docutils literal"><span class="pre">fillna</span></code>
which can take either a single value or a Series. The Series in this
case has to have keys which are the column names to be filled, and the
values are what to fill with.</p>
<p>For example, suppose that for all of the float columns we want to impute
with the median, and for all of the rest we want to impute with the
mode. We can use the <code class="docutils literal"><span class="pre">select_dtypes</span></code> to select the columns of a
certain type.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">imp_values</span> <span class="o">=</span> <span class="n">mel</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># mode returns a DataFrame</span>
<span class="n">imp_values</span> <span class="o">=</span> <span class="n">imp_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mel</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">())</span>
</pre></div>
</div>
<p>We used <code class="docutils literal"><span class="pre">append</span></code> to combine the two resulting Series to give us the
following,</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">imp_values</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Suburb</span>                              <span class="n">Reservoir</span>
<span class="n">Address</span>                          <span class="mi">5</span> <span class="n">Charles</span> <span class="n">St</span>
<span class="n">Rooms</span>                                       <span class="mi">3</span>
<span class="n">Type</span>                                        <span class="n">h</span>
<span class="n">Method</span>                                      <span class="n">S</span>
<span class="n">SellerG</span>                                <span class="n">Jellis</span>
<span class="n">Date</span>                      <span class="mi">2017</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">28</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
<span class="n">YearBuilt</span>                                <span class="mi">1970</span>
<span class="n">CouncilArea</span>           <span class="n">Boroondara</span> <span class="n">City</span> <span class="n">Council</span>
<span class="n">Regionname</span>              <span class="n">Southern</span> <span class="n">Metropolitan</span>
<span class="n">Suburb_miss</span>                             <span class="kc">False</span>
<span class="n">Address_miss</span>                            <span class="kc">False</span>
<span class="n">Rooms_miss</span>                              <span class="kc">False</span>
<span class="n">Type_miss</span>                               <span class="kc">False</span>
<span class="n">Price_miss</span>                              <span class="kc">False</span>
<span class="n">Method_miss</span>                             <span class="kc">False</span>
<span class="n">SellerG_miss</span>                            <span class="kc">False</span>
<span class="n">Date_miss</span>                               <span class="kc">False</span>
<span class="n">Distance_miss</span>                           <span class="kc">False</span>
<span class="n">Postcode_miss</span>                           <span class="kc">False</span>
<span class="n">Bedroom2_miss</span>                           <span class="kc">False</span>
<span class="n">Bathroom_miss</span>                           <span class="kc">False</span>
<span class="n">Car_miss</span>                                <span class="kc">False</span>
<span class="n">Landsize_miss</span>                           <span class="kc">False</span>
<span class="n">BuildingArea_miss</span>                        <span class="kc">True</span>
<span class="n">YearBuilt_miss</span>                           <span class="kc">True</span>
<span class="n">CouncilArea_miss</span>                        <span class="kc">False</span>
<span class="n">Lattitude_miss</span>                          <span class="kc">False</span>
<span class="n">Longtitude_miss</span>                         <span class="kc">False</span>
<span class="n">Regionname_miss</span>                         <span class="kc">False</span>
<span class="n">Propertycount_miss</span>                      <span class="kc">False</span>
<span class="n">Price</span>                                  <span class="mi">870000</span>
<span class="n">Distance</span>                                 <span class="mf">10.3</span>
<span class="n">Postcode</span>                                 <span class="mi">3103</span>
<span class="n">Bedroom2</span>                                    <span class="mi">3</span>
<span class="n">Bathroom</span>                                    <span class="mi">2</span>
<span class="n">Car</span>                                         <span class="mi">2</span>
<span class="n">Landsize</span>                                  <span class="mi">521</span>
<span class="n">BuildingArea</span>                              <span class="mi">136</span>
<span class="n">Lattitude</span>                            <span class="o">-</span><span class="mf">37.8076</span>
<span class="n">Longtitude</span>                            <span class="mf">145.008</span>
<span class="n">Propertycount</span>                            <span class="mi">6763</span>
<span class="n">dtype</span><span class="p">:</span> <span class="nb">object</span>
</pre></div>
</div>
<p>Now we are prepared to impute with these values. We are only going to
impute with this simple scheme when CouncilArea is missing however,
which we will explain shortly.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">ca_na</span> <span class="o">=</span> <span class="n">mel</span><span class="p">[</span><span class="s1">&#39;CouncilArea&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
<span class="n">mel</span><span class="p">[</span><span class="n">ca_na</span><span class="p">]</span> <span class="o">=</span> <span class="n">mel</span><span class="p">[</span><span class="n">ca_na</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">imp_values</span><span class="p">)</span>
</pre></div>
</div>
<p>We will impute using the CouncilArea as a predictor, but when it is
missing we will need to impute using a single value for each column.
There are only three rows with missing CouncilArea though, so this is
just for completeness sake. For comparison purposes however, we can make
a copy of the Price and look at the distribution before and after
imputation with a single value.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">price</span> <span class="o">=</span> <span class="n">mel</span><span class="p">[</span><span class="s1">&#39;Price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
<p>We will first look at the histogram of Price when it is non-missing. We
can see from the imputed value above that the median is 870,000 AUD.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">price</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Histogram of Price: non-missing&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/missingness_52_0.png" src="../_images/missingness_52_0.png" />
<p>Contrasting this with the histogram of the Price after we impute with
the median for the non-missing, we see one immediate deficiency of
imputing with a single value.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">price</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">imp_values</span><span class="p">[</span><span class="s1">&#39;Price&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Histogram of Price: single value imputation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/missingness_54_0.png" src="../_images/missingness_54_0.png" />
<p>The histogram now has a spike at the imputed value. This indicates that
if we impute with a single value then the sample distribution will have
a point mass. Imputing with the median will preserve the median, but
statistics regarding the spread of the distribution will be lower, for
example, compare the median and standard deviation below (50% and std).</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">price</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">count</span>    <span class="mf">2.724700e+04</span>
<span class="n">mean</span>     <span class="mf">1.050173e+06</span>
<span class="n">std</span>      <span class="mf">6.414671e+05</span>
<span class="nb">min</span>      <span class="mf">8.500000e+04</span>
<span class="mi">25</span><span class="o">%</span>      <span class="mf">6.350000e+05</span>
<span class="mi">50</span><span class="o">%</span>      <span class="mf">8.700000e+05</span>
<span class="mi">75</span><span class="o">%</span>      <span class="mf">1.295000e+06</span>
<span class="nb">max</span>      <span class="mf">1.120000e+07</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">Price</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">price</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">imp_values</span><span class="p">[</span><span class="s1">&#39;Price&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">count</span>    <span class="mf">3.485700e+04</span>
<span class="n">mean</span>     <span class="mf">1.010838e+06</span>
<span class="n">std</span>      <span class="mf">5.719992e+05</span>
<span class="nb">min</span>      <span class="mf">8.500000e+04</span>
<span class="mi">25</span><span class="o">%</span>      <span class="mf">6.950000e+05</span>
<span class="mi">50</span><span class="o">%</span>      <span class="mf">8.700000e+05</span>
<span class="mi">75</span><span class="o">%</span>      <span class="mf">1.150000e+06</span>
<span class="nb">max</span>      <span class="mf">1.120000e+07</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">Price</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</pre></div>
</div>
<p>The standard deviation for the imputed distribution is significantly smaller than the original standard deviation for non-missing Price.
If we would like to get a more plausible sample distribution for the
Price after imputation, then we have two choices: multiple imputation
(which we will not go into) and imputation using prediction.</p>
<p>In Pandas, you can also use <code class="docutils literal"><span class="pre">fillna</span></code> to impute with a time series by
filling in the entries by padding from a given value. This type of
padding can be done in a forward or backward fashion. While we could use
Date to impute the Price, it will likely be more effective to use either
locational information or all of the continuous/ordinal variables
including Date.</p>
</div>
<div class="section" id="imputation-by-prediction">
<h3>Imputation by Prediction<a class="headerlink" href="#imputation-by-prediction" title="Permalink to this headline">¶</a></h3>
<p>If the Price is MAR then we can impute by thinking of this as a prediction problem, with all other
variables and their missingness statuses as predictors and the Price as
a response.</p>
<p>We will first impute all of the variables using CouncilArea as the sole
predictor. We can simply think of this as grouping by the CouncilArea
and then imputing with a single value for that group and column.
CouncilArea is a good choice as a variable to condition on since it is
mostly non-missing, and as we will see in the next code block, when we
group by the CouncilArea there are no columns that are all missing in a
group. Hence, if we want to impute with the median or mode within a
group, this will always be well defined.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">ca_groupct</span> <span class="o">=</span> <span class="n">mel</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;CouncilArea&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="p">(</span><span class="n">ca_groupct</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
<span class="c1"># is there any column that is all NaN for any council?</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kc">False</span>
</pre></div>
</div>
<p>In order to impute within groups we will combine the <code class="docutils literal"><span class="pre">groupby</span></code> method
with the <code class="docutils literal"><span class="pre">transform</span></code>. The idea is that we want to make a
transformation within each group, and this can be accomplished in the
following way. But we first need to create a function that defines how
we want to impute within the groups (which is the tranformation that
needs to be applied).</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">impute_med</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;impute NaNs for Series x with median if it is a float and mode otherwise&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">median</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span>  <span class="o">==</span> <span class="s2">&quot;YearBuilt&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">mode</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">mode</span><span class="p">())</span>
</pre></div>
</div>
<p>In the above transformation, we test if the Series has a float dtype,
and if so fill the NaNs with the median, otherwise we use the mode. The
YearBuild variable is causing some troubles because the mode returns a
Series and not a single value, so we will deal with that variable
specifically by looking at the <code class="docutils literal"><span class="pre">name</span></code> of the Series.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">CA</span> <span class="o">=</span> <span class="n">mel</span><span class="p">[</span><span class="s1">&#39;CouncilArea&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># the process does not preserve CouncilArea, save it</span>
<span class="n">mel</span><span class="p">[</span><span class="o">~</span><span class="n">ca_na</span><span class="p">]</span> <span class="o">=</span> <span class="n">mel</span><span class="p">[</span><span class="o">~</span><span class="n">ca_na</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;CouncilArea&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">impute_med</span><span class="p">)</span>
<span class="n">mel</span><span class="p">[</span><span class="s1">&#39;CouncilArea&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CA</span> <span class="c1"># rewrite CouncilArea</span>
</pre></div>
</div>
<p>We can see that now all values have been imputed.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mel</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 34857 entries, 0 to 34856
Data columns (total 42 columns):
Suburb                34857 non-null object
Address               34857 non-null object
Rooms                 34857 non-null int64
Type                  34857 non-null object
Price                 34857 non-null float64
Method                34857 non-null object
SellerG               34857 non-null object
Date                  34857 non-null datetime64[ns]
Distance              34857 non-null float64
Postcode              34857 non-null float64
Bedroom2              34857 non-null float64
Bathroom              34857 non-null float64
Car                   34857 non-null float64
Landsize              34857 non-null float64
BuildingArea          34857 non-null float64
YearBuilt             34857 non-null object
CouncilArea           34857 non-null object
Lattitude             34857 non-null float64
Longtitude            34857 non-null float64
Regionname            34857 non-null object
Propertycount         34857 non-null float64
Suburb_miss           34857 non-null bool
Address_miss          34857 non-null bool
Rooms_miss            34857 non-null bool
Type_miss             34857 non-null bool
Price_miss            34857 non-null bool
Method_miss           34857 non-null bool
SellerG_miss          34857 non-null bool
Date_miss             34857 non-null bool
Distance_miss         34857 non-null bool
Postcode_miss         34857 non-null bool
Bedroom2_miss         34857 non-null bool
Bathroom_miss         34857 non-null bool
Car_miss              34857 non-null bool
Landsize_miss         34857 non-null bool
BuildingArea_miss     34857 non-null bool
YearBuilt_miss        34857 non-null bool
CouncilArea_miss      34857 non-null bool
Lattitude_miss        34857 non-null bool
Longtitude_miss       34857 non-null bool
Regionname_miss       34857 non-null bool
Propertycount_miss    34857 non-null bool
dtypes: bool(21), datetime64[ns](1), float64(11), int64(1), object(8)
memory usage: 6.3+ MB
</pre></div>
</div>
<p>Again, we can look at the histogram,</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mel</span><span class="p">[</span><span class="s1">&#39;Price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Histogram of Price: imputed by CouncilArea&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/missingness_68_0.png" src="../_images/missingness_68_0.png" />
<p>While there seems to be a larger spike around 1M AUD, the sample
distribution does look more like the original sample distribution.</p>
<p>We have seen how you can impute with a categorical variable as the
predictor using <code class="docutils literal"><span class="pre">groupby</span></code>. We can also think about using the other
variables, particularly the numerical variables, in a linear regressor.
Before we do this however, we would like to compare prediction with the
numerical variables against predicting with CouncilArea. To do this
let&#8217;s make a training and testing split of the observed Price data
(using the <code class="docutils literal"><span class="pre">Price_miss</span></code> variable). We will see the <code class="docutils literal"><span class="pre">sklearn</span></code> package
later, but for now, we will just import the <code class="docutils literal"><span class="pre">train_test_split</span></code>
function. This makes a randomized split of the data with a default of a
3:1 ratio for train and test sets respectively.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="k">import</span> <span class="n">train_test_split</span>

<span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">mel</span><span class="p">[</span><span class="o">~</span><span class="n">mel</span><span class="p">[</span><span class="s1">&#39;Price_miss&#39;</span><span class="p">]])</span>
</pre></div>
</div>
<p>We will extract the predictions in the form of a Series with the
CouncilArea as the index and the mean Price within that CouncilArea as
the values.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">ca_na</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;CouncilArea_miss&#39;</span><span class="p">]</span>
<span class="n">tr_preds</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="o">~</span><span class="n">ca_na</span><span class="p">][[</span><span class="s1">&#39;CouncilArea&#39;</span><span class="p">,</span><span class="s1">&#39;Price&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;CouncilArea&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
<p>We will then join this series to the full Price data with the
CouncilArea as the index. Notice that the left DataFrame is much larger
and has many duplicate indices, while the indices in the right DataFrame
are unique. Because this is a left join, the right Dataframe rows will
be multiplied to match the multiple rows on the left.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">test_dat</span> <span class="o">=</span> <span class="n">test</span><span class="p">[[</span><span class="s1">&#39;CouncilArea&#39;</span><span class="p">,</span><span class="s1">&#39;Price&#39;</span><span class="p">]]</span>
<span class="n">test_dat</span> <span class="o">=</span> <span class="n">test_dat</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;CouncilArea&#39;</span><span class="p">)</span>
<span class="n">test_dat</span> <span class="o">=</span> <span class="n">test_dat</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tr_preds</span><span class="p">,</span><span class="n">rsuffix</span><span class="o">=</span><span class="s1">&#39;_pred&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We can look at the result and see that the behavior is as expected, the
<code class="docutils literal"><span class="pre">Price_pred</span></code> is dependent on the CouncilArea.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">test_dat</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Price</th>
      <th>Price_pred</th>
    </tr>
    <tr>
      <th>CouncilArea</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Banyule City Council</th>
      <td>1278000.0</td>
      <td>942259.175601</td>
    </tr>
    <tr>
      <th>Banyule City Council</th>
      <td>845000.0</td>
      <td>942259.175601</td>
    </tr>
    <tr>
      <th>Banyule City Council</th>
      <td>985000.0</td>
      <td>942259.175601</td>
    </tr>
    <tr>
      <th>Banyule City Council</th>
      <td>690000.0</td>
      <td>942259.175601</td>
    </tr>
    <tr>
      <th>Banyule City Council</th>
      <td>728500.0</td>
      <td>942259.175601</td>
    </tr>
  </tbody>
</table>
</div><p>We can simply calculate the square error test error using the <code class="docutils literal"><span class="pre">eval</span></code>
method. We have not gone over the <code class="docutils literal"><span class="pre">eval</span></code> method, but it is often
handy. Since the columns are named, we can write mathematical
expressions using them, then <code class="docutils literal"><span class="pre">eval</span></code> will evaluate it for every row of
the DataFrame. We then calculate the mean.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">CA_error</span> <span class="o">=</span> <span class="n">test_dat</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s1">&#39;(Price - Price_pred)**2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">CA_error</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mf">312621748714.5273</span>
</pre></div>
</div>
<p>Let&#8217;s consider using linear regression to predict the Price instead. We
will create a handy function to select the desired predictor and
response DataFrames below. We will exclude the non-numeric variables
from the predictors. Critically, the missingness indicators are all
included as predictor variables. We also cast the result as Numpy
Arrrays with dtype of float.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">select_preds</span><span class="p">(</span><span class="n">train</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
    <span class="n">X_tr</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">bool</span><span class="p">,</span><span class="nb">int</span><span class="p">])</span>
    <span class="n">Y_tr</span> <span class="o">=</span> <span class="n">X_tr</span><span class="p">[</span><span class="s1">&#39;Price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">del</span> <span class="n">X_tr</span><span class="p">[</span><span class="s1">&#39;Price&#39;</span><span class="p">]</span>
    <span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">X_tr</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">X_tr</span><span class="p">,</span> <span class="n">Y_tr</span> <span class="o">=</span> <span class="n">X_tr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span> <span class="n">Y_tr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Y_tr</span><span class="p">,</span> <span class="n">X_tr</span>
</pre></div>
</div>
<p>We then apply this to the train and test sets and fit OLS and predict on
the test set.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">Y_tr</span><span class="p">,</span> <span class="n">X_tr</span> <span class="o">=</span> <span class="n">select_preds</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
<span class="n">Y_te</span><span class="p">,</span> <span class="n">X_te</span> <span class="o">=</span> <span class="n">select_preds</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
<span class="n">ols_res</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">Y_tr</span><span class="p">,</span><span class="n">X_tr</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">Y_pred</span> <span class="o">=</span> <span class="n">ols_res</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_te</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">ols_res</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
<table class="simpletable">
<caption>OLS Regression Results</caption>
<tr>
  <th>Dep. Variable:</th>          <td>Price</td>      <th>  R-squared:         </th>  <td>   0.852</td>
</tr>
<tr>
  <th>Model:</th>                   <td>OLS</td>       <th>  Adj. R-squared:    </th>  <td>   0.852</td>
</tr>
<tr>
  <th>Method:</th>             <td>Least Squares</td>  <th>  F-statistic:       </th>  <td>   5871.</td>
</tr>
<tr>
  <th>Date:</th>             <td>Thu, 20 Sep 2018</td> <th>  Prob (F-statistic):</th>   <td>  0.00</td>
</tr>
<tr>
  <th>Time:</th>                 <td>09:42:51</td>     <th>  Log-Likelihood:    </th> <td>-2.9610e+05</td>
</tr>
<tr>
  <th>No. Observations:</th>      <td> 20435</td>      <th>  AIC:               </th>  <td>5.922e+05</td>
</tr>
<tr>
  <th>Df Residuals:</th>          <td> 20415</td>      <th>  BIC:               </th>  <td>5.924e+05</td>
</tr>
<tr>
  <th>Df Model:</th>              <td>    20</td>      <th>                     </th>      <td> </td>
</tr>
<tr>
  <th>Covariance Type:</th>      <td>nonrobust</td>    <th>                     </th>      <td> </td>
</tr>
</table>
<table class="simpletable">
<tr>
           <td></td>             <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>
</tr>
<tr>
  <th>Rooms</th>              <td> 3.419e+05</td> <td> 6794.377</td> <td>   50.315</td> <td> 0.000</td> <td> 3.29e+05</td> <td> 3.55e+05</td>
</tr>
<tr>
  <th>Distance</th>           <td>-4.733e+04</td> <td>  604.181</td> <td>  -78.341</td> <td> 0.000</td> <td>-4.85e+04</td> <td>-4.61e+04</td>
</tr>
<tr>
  <th>Postcode</th>           <td> 1160.6889</td> <td>   35.744</td> <td>   32.472</td> <td> 0.000</td> <td> 1090.628</td> <td> 1230.750</td>
</tr>
<tr>
  <th>Bedroom2</th>           <td> -3.49e+04</td> <td> 8042.990</td> <td>   -4.339</td> <td> 0.000</td> <td>-5.07e+04</td> <td>-1.91e+04</td>
</tr>
<tr>
  <th>Bathroom</th>           <td> 1.741e+05</td> <td> 6443.674</td> <td>   27.020</td> <td> 0.000</td> <td> 1.61e+05</td> <td> 1.87e+05</td>
</tr>
<tr>
  <th>Car</th>                <td> 5.412e+04</td> <td> 4224.249</td> <td>   12.812</td> <td> 0.000</td> <td> 4.58e+04</td> <td> 6.24e+04</td>
</tr>
<tr>
  <th>Landsize</th>           <td>    4.1204</td> <td>    0.998</td> <td>    4.128</td> <td> 0.000</td> <td>    2.164</td> <td>    6.077</td>
</tr>
<tr>
  <th>BuildingArea</th>       <td>   60.9449</td> <td>   10.398</td> <td>    5.861</td> <td> 0.000</td> <td>   40.565</td> <td>   81.325</td>
</tr>
<tr>
  <th>Lattitude</th>          <td>-1.258e+06</td> <td> 4.03e+04</td> <td>  -31.204</td> <td> 0.000</td> <td>-1.34e+06</td> <td>-1.18e+06</td>
</tr>
<tr>
  <th>Longtitude</th>         <td>-3.509e+05</td> <td> 1.05e+04</td> <td>  -33.521</td> <td> 0.000</td> <td>-3.71e+05</td> <td> -3.3e+05</td>
</tr>
<tr>
  <th>Propertycount</th>      <td>   -1.3879</td> <td>    0.743</td> <td>   -1.868</td> <td> 0.062</td> <td>   -2.844</td> <td>    0.069</td>
</tr>
<tr>
  <th>Suburb_miss</th>        <td> 6.778e-08</td> <td> 2.01e-08</td> <td>    3.380</td> <td> 0.001</td> <td> 2.85e-08</td> <td> 1.07e-07</td>
</tr>
<tr>
  <th>Address_miss</th>       <td>-2.664e-07</td> <td> 7.85e-08</td> <td>   -3.395</td> <td> 0.001</td> <td> -4.2e-07</td> <td>-1.13e-07</td>
</tr>
<tr>
  <th>Rooms_miss</th>         <td> 4.365e-07</td> <td> 1.29e-07</td> <td>    3.395</td> <td> 0.001</td> <td> 1.84e-07</td> <td> 6.88e-07</td>
</tr>
<tr>
  <th>Type_miss</th>          <td>   5.8e-08</td> <td> 1.71e-08</td> <td>    3.395</td> <td> 0.001</td> <td> 2.45e-08</td> <td> 9.15e-08</td>
</tr>
<tr>
  <th>Price_miss</th>         <td> 1.287e-08</td> <td>  3.8e-09</td> <td>    3.390</td> <td> 0.001</td> <td> 5.43e-09</td> <td> 2.03e-08</td>
</tr>
<tr>
  <th>Method_miss</th>        <td>-2.877e-08</td> <td>  8.5e-09</td> <td>   -3.385</td> <td> 0.001</td> <td>-4.54e-08</td> <td>-1.21e-08</td>
</tr>
<tr>
  <th>SellerG_miss</th>       <td>-2.241e-08</td> <td> 6.49e-09</td> <td>   -3.452</td> <td> 0.001</td> <td>-3.51e-08</td> <td>-9.68e-09</td>
</tr>
<tr>
  <th>Date_miss</th>          <td>-1.267e-08</td> <td> 3.77e-09</td> <td>   -3.365</td> <td> 0.001</td> <td>-2.01e-08</td> <td>-5.29e-09</td>
</tr>
<tr>
  <th>Distance_miss</th>      <td> -1.75e+05</td> <td> 2.91e+05</td> <td>   -0.601</td> <td> 0.548</td> <td>-7.45e+05</td> <td> 3.95e+05</td>
</tr>
<tr>
  <th>Postcode_miss</th>      <td> -1.75e+05</td> <td> 2.91e+05</td> <td>   -0.601</td> <td> 0.548</td> <td>-7.45e+05</td> <td> 3.95e+05</td>
</tr>
<tr>
  <th>Bedroom2_miss</th>      <td>-1.244e+06</td> <td> 3.38e+05</td> <td>   -3.677</td> <td> 0.000</td> <td>-1.91e+06</td> <td>-5.81e+05</td>
</tr>
<tr>
  <th>Bathroom_miss</th>      <td> 1.109e+06</td> <td> 3.37e+05</td> <td>    3.289</td> <td> 0.001</td> <td> 4.48e+05</td> <td> 1.77e+06</td>
</tr>
<tr>
  <th>Car_miss</th>           <td> 7.084e+04</td> <td> 2.85e+04</td> <td>    2.484</td> <td> 0.013</td> <td>  1.5e+04</td> <td> 1.27e+05</td>
</tr>
<tr>
  <th>Landsize_miss</th>      <td>-1.822e+04</td> <td> 1.12e+04</td> <td>   -1.630</td> <td> 0.103</td> <td>-4.01e+04</td> <td> 3691.804</td>
</tr>
<tr>
  <th>BuildingArea_miss</th>  <td> 1.264e+04</td> <td> 1.25e+04</td> <td>    1.015</td> <td> 0.310</td> <td>-1.18e+04</td> <td> 3.71e+04</td>
</tr>
<tr>
  <th>YearBuilt_miss</th>     <td> 4.737e+04</td> <td> 1.26e+04</td> <td>    3.757</td> <td> 0.000</td> <td> 2.27e+04</td> <td> 7.21e+04</td>
</tr>
<tr>
  <th>CouncilArea_miss</th>   <td>-4.717e+04</td> <td> 1.12e+05</td> <td>   -0.421</td> <td> 0.674</td> <td>-2.67e+05</td> <td> 1.72e+05</td>
</tr>
<tr>
  <th>Lattitude_miss</th>     <td>-1.956e+04</td> <td> 1.89e+04</td> <td>   -1.034</td> <td> 0.301</td> <td>-5.66e+04</td> <td> 1.75e+04</td>
</tr>
<tr>
  <th>Longtitude_miss</th>    <td>-1.956e+04</td> <td> 1.89e+04</td> <td>   -1.034</td> <td> 0.301</td> <td>-5.66e+04</td> <td> 1.75e+04</td>
</tr>
<tr>
  <th>Regionname_miss</th>    <td>-4.717e+04</td> <td> 1.12e+05</td> <td>   -0.421</td> <td> 0.674</td> <td>-2.67e+05</td> <td> 1.72e+05</td>
</tr>
<tr>
  <th>Propertycount_miss</th> <td>-4.717e+04</td> <td> 1.12e+05</td> <td>   -0.421</td> <td> 0.674</td> <td>-2.67e+05</td> <td> 1.72e+05</td>
</tr>
</table>
<table class="simpletable">
<tr>
  <th>Omnibus:</th>       <td>13579.846</td> <th>  Durbin-Watson:     </th>  <td>   2.004</td>
</tr>
<tr>
  <th>Prob(Omnibus):</th>  <td> 0.000</td>   <th>  Jarque-Bera (JB):  </th> <td>485785.597</td>
</tr>
<tr>
  <th>Skew:</th>           <td> 2.698</td>   <th>  Prob(JB):          </th>  <td>    0.00</td>
</tr>
<tr>
  <th>Kurtosis:</th>       <td>26.269</td>   <th>  Cond. No.          </th>  <td>1.20e+16</td>
</tr>
</table><br/><br/>Warnings:<br/>[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.<br/>[2] The smallest eigenvalue is 1.21e-20. This might indicate that there are<br/>strong multicollinearity problems or that the design matrix is singular.<p>There seem to be many strong predictors in the OLS, particularly,
variables like Rooms, Distance, Cars, Bathroom, but also the missingness
indicators seem to have some predictive power. Interestingly the postal
code is also predictive in a linear model, even though using the postal
code as a numerical variable in linear regression does not make much
sense, although nearby postal codes do tend to be close geographically.</p>
<p>Regardless, because we are doing a train-test split, we can feel
confident that the resulting test error is a good estimate of the risk
of the prediction.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">ols_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">Y_pred</span> <span class="o">-</span> <span class="n">Y_te</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ols_error</span> <span class="o">/</span> <span class="n">CA_error</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mf">0.7162549957690686</span>
</pre></div>
</div>
<p>We see that the test error from the OLS is 71.6% of the prediction from
the CouncilArea, and we can confidently use the OLS prediction to impute
the missing Prices.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">Y</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">select_preds</span><span class="p">(</span><span class="n">mel</span><span class="p">[</span><span class="o">~</span><span class="n">mel</span><span class="p">[</span><span class="s1">&#39;Price_miss&#39;</span><span class="p">]])</span>
<span class="n">_</span><span class="p">,</span> <span class="n">X_miss</span> <span class="o">=</span> <span class="n">select_preds</span><span class="p">(</span><span class="n">mel</span><span class="p">[</span><span class="n">mel</span><span class="p">[</span><span class="s1">&#39;Price_miss&#39;</span><span class="p">]])</span>
<span class="n">ols_res</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">Y_pred</span> <span class="o">=</span> <span class="n">ols_res</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_miss</span><span class="p">)</span>
<span class="n">mel</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mel</span><span class="p">[</span><span class="s1">&#39;Price_miss&#39;</span><span class="p">],</span><span class="s1">&#39;Price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Y_pred</span>
</pre></div>
</div>
<p>We have used more basic Pandas indexing and assignment to do the
imputation above. Try to follow the precise operations we have
performed. As usual, we can look at the sample distribution for the
resulting imputation.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mel</span><span class="p">[</span><span class="s1">&#39;Price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Histogram of Price: imputed with OLS&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/missingness_89_0.png" src="../_images/missingness_89_0.png" />
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Data Wrangling</a><ul>
<li><a class="reference internal" href="#introduction-to-pandas">Introduction to Pandas</a><ul>
<li><a class="reference internal" href="#series">Series</a></li>
<li><a class="reference internal" href="#dataframe">Dataframe</a></li>
</ul>
</li>
<li><a class="reference internal" href="#wrangling-data-with-indices">Wrangling data with indices</a><ul>
<li><a class="reference internal" href="#reading-data-and-datetime-indexing">Reading data and datetime indexing</a></li>
<li><a class="reference internal" href="#advanced-indexing-in-pandas">Advanced Indexing in Pandas</a></li>
<li><a class="reference internal" href="#grouping-aggregating-transforming">Grouping, aggregating, transforming</a></li>
<li><a class="reference internal" href="#concatenating-and-joining-dataframes">Concatenating and joining DataFrames</a></li>
</ul>
</li>
<li><a class="reference internal" href="#missingness">Missingness</a><ul>
<li><a class="reference internal" href="#looking-at-missingness-in-pandas">Looking at missingness in Pandas</a></li>
<li><a class="reference internal" href="#dealing-with-missingness-and-simple-imputation">Dealing with missingness and simple imputation</a></li>
<li><a class="reference internal" href="#imputation-by-prediction">Imputation by Prediction</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="learning.html" title="previous chapter">Statistical Learning Machines</a></li>
      <li>Next: <a href="visualization.html" title="next chapter">Data Visualization</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/unit1/wrangling.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, James Sharpnack.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
      |
      <a href="../_sources/unit1/wrangling.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>