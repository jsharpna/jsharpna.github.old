<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Missingness &#8212; DataTech 1.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="missingness">
<h1>Missingness<a class="headerlink" href="#missingness" title="Permalink to this headline">¶</a></h1>
<p>Missing data is one of the most common unforeseen issues in data
analysis. In a prediction problem, we can deal with missing predictor
variables by engineering features that are missingness-aware. In this
case, simple imputation methods may suffice. When a variable of interest
is missing, such as the response variable in prediction, these same
imputation methods may lead us to some strange conclusions. First, let&#8217;s
go over some basics of missing data.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
</pre></div>
</div>
<p>Let&#8217;s begin our discussion of the different types of missing by
simulating a dataset with missingness. In the following, we have a
dataset with two variable where each entry of the first is not missing
with probability .84 and is missing otherwise. The second variable is
non-missing.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="o">.</span><span class="mi">84</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,(</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">.</span><span class="mi">84</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
<span class="n">X</span><span class="p">[</span><span class="n">M</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="c1"># X0 is not missing with prob .84</span>
<span class="n">X_MCAR</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">X_MCAR</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.327573</td>
      <td>-2.403688</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-0.549736</td>
      <td>-0.537814</td>
    </tr>
    <tr>
      <th>2</th>
      <td>NaN</td>
      <td>-0.169579</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.047577</td>
      <td>-0.013752</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.808157</td>
      <td>0.234873</td>
    </tr>
  </tbody>
</table>
</div><p>We can see that a missing value is encoded as a NaN in the DataFrame.
The missing value may be encoded differently depending on the column
type (datetimes encode missingness as NaT for example). For numerical
types this is <code class="docutils literal"><span class="pre">np.nan</span></code>.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">X_MCAR</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>170.000000</td>
      <td>200.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>-0.176160</td>
      <td>-0.055610</td>
    </tr>
    <tr>
      <th>std</th>
      <td>1.019463</td>
      <td>0.949872</td>
    </tr>
    <tr>
      <th>min</th>
      <td>-2.460313</td>
      <td>-2.403688</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>-0.919884</td>
      <td>-0.616639</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>-0.242606</td>
      <td>-0.046619</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>0.515983</td>
      <td>0.634754</td>
    </tr>
    <tr>
      <th>max</th>
      <td>2.886748</td>
      <td>2.643257</td>
    </tr>
  </tbody>
</table>
</div><p>We can see that there are many missing values because the <code class="docutils literal"><span class="pre">count</span></code> is
smaller in X0. All of statistics in the <code class="docutils literal"><span class="pre">describe</span></code> function other than
<code class="docutils literal"><span class="pre">count</span></code> are computed with the missingness ignored. Typically, Pandas
ignores missingness by default when computing statistics and making
plots. We can expect that because the missingness is done randomly and
independently of the other variables then these statistics are unbiased
for the population statistics (if there was no missingness).</p>
<p><strong>Def.</strong> When a variable is missing independently and at random, and the
missingness status is not dependent on any observed value, we say the
variable is <em>missing completely at random (MCAR)</em>. In this case variable
X0 is MCAR because the missingness is not dependent on X1.</p>
<p>Let&#8217;s simulate from a model where the missingness is dependent on the
second variable, X1.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,(</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">X</span><span class="p">[</span><span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="c1"># X0 is missing if X1 &gt; 1</span>
<span class="n">X_MAR</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">X_MAR</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>172.000000</td>
      <td>200.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>0.007135</td>
      <td>-0.012531</td>
    </tr>
    <tr>
      <th>std</th>
      <td>1.027917</td>
      <td>0.961955</td>
    </tr>
    <tr>
      <th>min</th>
      <td>-2.497748</td>
      <td>-2.568347</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>-0.744684</td>
      <td>-0.557767</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>-0.100491</td>
      <td>0.030946</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>0.622769</td>
      <td>0.551149</td>
    </tr>
    <tr>
      <th>max</th>
      <td>2.509379</td>
      <td>3.018901</td>
    </tr>
  </tbody>
</table>
</div><p>We can see that <code class="docutils literal"><span class="pre">count</span></code> is similar and none of the statistics for
variable X0 have significantly changed. This is because X1 was drawn
independently from X0, and so the missingness mechanism is also
independent from X0. We will return to this dataset.</p>
<p><strong>Def.</strong> When a variable is missing independently and at random, but the
missingness status is dependent on another observed variable, we say the
variable is <em>missing at random (MAR)</em>. In the case above, X0 is MAR
because the missingness is dependent on X1 but not explicitely on X0.</p>
<p>Let&#8217;s simulate from another model where the missingness of X0 is
dependent on its value.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,(</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">X</span><span class="p">[</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="c1"># X0 is missing if X0 &gt; 1</span>
<span class="n">X_MNAR</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">X_MNAR</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>167.000000</td>
      <td>200.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>-0.270645</td>
      <td>-0.050537</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.816188</td>
      <td>0.972811</td>
    </tr>
    <tr>
      <th>min</th>
      <td>-2.974269</td>
      <td>-2.888389</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>-0.884813</td>
      <td>-0.690774</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>-0.151122</td>
      <td>-0.065065</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>0.310640</td>
      <td>0.704453</td>
    </tr>
    <tr>
      <th>max</th>
      <td>0.993096</td>
      <td>1.992330</td>
    </tr>
  </tbody>
</table>
</div><p>We see that <code class="docutils literal"><span class="pre">count</span></code> is again similar to the previous statistics, but
the other statistics have changed dramatically. The mean is brought down
because we made the large values of X0 be missing, and this has likewise
reduced the <code class="docutils literal"><span class="pre">max</span></code> which is concentrating around 1.</p>
<p><strong>Def.</strong> When a variable&#8217;s missingness remains dependent on its latent
value, even after conditioning on other observed values, this is called
<em>missing not at random (MNAR)</em>. This happens when the missingness is
neither MAR or MCAR.</p>
<div class="section" id="looking-at-missingness-in-pandas">
<h2>Looking at missingness in Pandas<a class="headerlink" href="#looking-at-missingness-in-pandas" title="Permalink to this headline">¶</a></h2>
<p>There is typically not much we can do about MNAR data if the missing
variable is of interest. On the other hand, we can sometimes guess at
the missingness mechanism. For example, if we had looked at the
histograms of the data,</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">X_MNAR</span><span class="o">.</span><span class="n">hist</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/missingness_12_0.png" src="../_images/missingness_12_0.png" />
<p>we might notice that variable X0 has a cliff at 1. We may correctly
suspect that all values above 1 were cencored.</p>
<p>How might we distinguish between the <code class="docutils literal"><span class="pre">X_MAR</span></code> and the <code class="docutils literal"><span class="pre">X_MCAR</span></code>
datasets if we did not already know how they were simulated? In Pandas,
we can test which entries are missing with <code class="docutils literal"><span class="pre">isna,</span> <span class="pre">notna</span></code>.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">X_MCAR</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2</th>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>3</th>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>4</th>
      <td>False</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div><p>This converted all of the entries to the True/False answer to &#8220;is this
value missing?&#8221;. This is the preferred way to evaluate missingness
because in Python <code class="docutils literal"><span class="pre">np.nan</span> <span class="pre">==</span> <span class="pre">np.nan</span></code> actually evaluates to False, so
testing with expressions of this type doesn&#8217;t work.</p>
<p>You should think of the result of <code class="docutils literal"><span class="pre">isna</span></code> as another variable that you
may want to include in your analysis. In prediction tasks we will often
include these variables when we do feature engineering, as we will see
later. For our purposes, we can see the difference between the <code class="docutils literal"><span class="pre">X_MAR</span></code>
and <code class="docutils literal"><span class="pre">X_MCAR</span></code> data with this missingness indicator included.
Specifically, we want to see what the dependence is between the
missingness and other variables. We can do this by grouping by the
missingness and describing the other variable. The following function
adds the missingness indicator to a dataset for a variable, removes that
variable, groups by the missingness, and describes the remaining
variables.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">desc_missing</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">missingvar</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Describes the variables conditioned on the missingness&quot;&quot;&quot;</span>
    <span class="n">X_mod</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">X_mod</span><span class="p">[</span><span class="s1">&#39;miss_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_mod</span><span class="p">[</span><span class="n">missingvar</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
    <span class="k">del</span> <span class="n">X_mod</span><span class="p">[</span><span class="n">missingvar</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">X_mod</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;miss_ind&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">desc_missing</span><span class="p">(</span><span class="n">X_MCAR</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="8" halign="left">1</th>
    </tr>
    <tr>
      <th></th>
      <th>count</th>
      <th>mean</th>
      <th>std</th>
      <th>min</th>
      <th>25%</th>
      <th>50%</th>
      <th>75%</th>
      <th>max</th>
    </tr>
    <tr>
      <th>miss_ind</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>False</th>
      <td>170.0</td>
      <td>-0.059364</td>
      <td>0.939388</td>
      <td>-2.403688</td>
      <td>-0.577253</td>
      <td>-0.046619</td>
      <td>0.575143</td>
      <td>2.643257</td>
    </tr>
    <tr>
      <th>True</th>
      <td>30.0</td>
      <td>-0.034340</td>
      <td>1.023837</td>
      <td>-2.152632</td>
      <td>-0.632773</td>
      <td>0.029868</td>
      <td>0.724111</td>
      <td>1.795847</td>
    </tr>
  </tbody>
</table>
</div><div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">desc_missing</span><span class="p">(</span><span class="n">X_MAR</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="8" halign="left">1</th>
    </tr>
    <tr>
      <th></th>
      <th>count</th>
      <th>mean</th>
      <th>std</th>
      <th>min</th>
      <th>25%</th>
      <th>50%</th>
      <th>75%</th>
      <th>max</th>
    </tr>
    <tr>
      <th>miss_ind</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>False</th>
      <td>172.0</td>
      <td>-0.255640</td>
      <td>0.790491</td>
      <td>-2.568347</td>
      <td>-0.695704</td>
      <td>-0.102948</td>
      <td>0.379905</td>
      <td>0.982192</td>
    </tr>
    <tr>
      <th>True</th>
      <td>28.0</td>
      <td>1.480858</td>
      <td>0.416369</td>
      <td>1.069409</td>
      <td>1.218558</td>
      <td>1.365086</td>
      <td>1.586109</td>
      <td>3.018901</td>
    </tr>
  </tbody>
</table>
</div><p>In the above displays, we see that for the MCAR dataset there is little
difference between the summary statistics for X1 when X0 is missing or
not. For the MAR dataset, there is a more pronounced difference between
the means of these two subsets of the data. This is one indication to us
that <code class="docutils literal"><span class="pre">X_MAR</span></code> is not MCAR.</p>
<p>We could also do this formally with a T-test for difference in means
between two samples to do this more formally. I will assume that you
recall the T-test for independence from your introductory statistics
course, if not please review it before trying to parse the following
code blocks.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_MCAR</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">missingvar</span><span class="p">,</span><span class="n">testvar</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test if testvar is independent of missingness</span>
<span class="sd">    Uses two-sided t-test with pooled variances</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">X_mod</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">X_mod</span><span class="p">[</span><span class="s1">&#39;miss_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_mod</span><span class="p">[</span><span class="n">missingvar</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
    <span class="k">del</span> <span class="n">X_mod</span><span class="p">[</span><span class="n">missingvar</span><span class="p">]</span>
    <span class="n">X1</span><span class="p">,</span><span class="n">X2</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="n">X_mod</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;miss_ind&#39;</span><span class="p">)]</span> <span class="c1">#split</span>
    <span class="k">return</span> <span class="n">sm</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">X1</span><span class="p">[</span><span class="n">testvar</span><span class="p">],</span><span class="n">X2</span><span class="p">[</span><span class="n">testvar</span><span class="p">])</span> <span class="c1">#return test</span>
</pre></div>
</div>
<p>In the above function we split the grouped dataframe based on the
missingness status. We used the <code class="docutils literal"><span class="pre">ttest_ind</span></code> method in statsmodels to
perform the two-sample t-test with pooled variances. The resulting
P-values are below:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;X_MCAR P-value: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_MCAR</span><span class="p">(</span><span class="n">X_MCAR</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;X_MAR P-value: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_MCAR</span><span class="p">(</span><span class="n">X_MAR</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">X_MCAR</span> <span class="n">P</span><span class="o">-</span><span class="n">value</span><span class="p">:</span> <span class="mf">0.8945613701172417</span>
<span class="n">X_MAR</span> <span class="n">P</span><span class="o">-</span><span class="n">value</span><span class="p">:</span> <span class="mf">2.4792949402817898e-23</span>
</pre></div>
</div>
<p>This provides more satisfying evidence that the dataset <code class="docutils literal"><span class="pre">X_MAR</span></code> is not
drawn MCAR.</p>
</div>
<div class="section" id="dealing-with-missingness-and-simple-imputation">
<h2>Dealing with missingness and simple imputation<a class="headerlink" href="#dealing-with-missingness-and-simple-imputation" title="Permalink to this headline">¶</a></h2>
<p>Imputation is the process of filling in missing values. There are few
great options when it comes to imputation, and very few general purpose
tools that will perfectly impute missing data. Let&#8217;s discuss some
reasonable simple options and their limitations.</p>
<p>Let&#8217;s begin by loading in the Melbourne housing dataset, which is from
the Kaggle competitions:
<a class="reference external" href="https://www.kaggle.com/anthonypino/melbourne-housing-market/version/26">https://www.kaggle.com/anthonypino/melbourne-housing-market/version/26</a>
The dataset describes home sales in Melborne, Australia.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mel</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/Melbourne_housing_FULL.csv&#39;</span><span class="p">)</span>
<span class="n">mel</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Suburb</th>
      <th>Address</th>
      <th>Rooms</th>
      <th>Type</th>
      <th>Price</th>
      <th>Method</th>
      <th>SellerG</th>
      <th>Date</th>
      <th>Distance</th>
      <th>Postcode</th>
      <th>...</th>
      <th>Bathroom</th>
      <th>Car</th>
      <th>Landsize</th>
      <th>BuildingArea</th>
      <th>YearBuilt</th>
      <th>CouncilArea</th>
      <th>Lattitude</th>
      <th>Longtitude</th>
      <th>Regionname</th>
      <th>Propertycount</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Abbotsford</td>
      <td>68 Studley St</td>
      <td>2</td>
      <td>h</td>
      <td>NaN</td>
      <td>SS</td>
      <td>Jellis</td>
      <td>3/09/2016</td>
      <td>2.5</td>
      <td>3067.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>126.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Yarra City Council</td>
      <td>-37.8014</td>
      <td>144.9958</td>
      <td>Northern Metropolitan</td>
      <td>4019.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Abbotsford</td>
      <td>85 Turner St</td>
      <td>2</td>
      <td>h</td>
      <td>1480000.0</td>
      <td>S</td>
      <td>Biggin</td>
      <td>3/12/2016</td>
      <td>2.5</td>
      <td>3067.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>202.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Yarra City Council</td>
      <td>-37.7996</td>
      <td>144.9984</td>
      <td>Northern Metropolitan</td>
      <td>4019.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Abbotsford</td>
      <td>25 Bloomburg St</td>
      <td>2</td>
      <td>h</td>
      <td>1035000.0</td>
      <td>S</td>
      <td>Biggin</td>
      <td>4/02/2016</td>
      <td>2.5</td>
      <td>3067.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>156.0</td>
      <td>79.0</td>
      <td>1900.0</td>
      <td>Yarra City Council</td>
      <td>-37.8079</td>
      <td>144.9934</td>
      <td>Northern Metropolitan</td>
      <td>4019.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Abbotsford</td>
      <td>18/659 Victoria St</td>
      <td>3</td>
      <td>u</td>
      <td>NaN</td>
      <td>VB</td>
      <td>Rounds</td>
      <td>4/02/2016</td>
      <td>2.5</td>
      <td>3067.0</td>
      <td>...</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Yarra City Council</td>
      <td>-37.8114</td>
      <td>145.0116</td>
      <td>Northern Metropolitan</td>
      <td>4019.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Abbotsford</td>
      <td>5 Charles St</td>
      <td>3</td>
      <td>h</td>
      <td>1465000.0</td>
      <td>SP</td>
      <td>Biggin</td>
      <td>4/03/2017</td>
      <td>2.5</td>
      <td>3067.0</td>
      <td>...</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>134.0</td>
      <td>150.0</td>
      <td>1900.0</td>
      <td>Yarra City Council</td>
      <td>-37.8093</td>
      <td>144.9944</td>
      <td>Northern Metropolitan</td>
      <td>4019.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 21 columns</p>
</div><div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mel</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 34857 entries, 0 to 34856
Data columns (total 21 columns):
Suburb           34857 non-null object
Address          34857 non-null object
Rooms            34857 non-null int64
Type             34857 non-null object
Price            27247 non-null float64
Method           34857 non-null object
SellerG          34857 non-null object
Date             34857 non-null object
Distance         34856 non-null float64
Postcode         34856 non-null float64
Bedroom2         26640 non-null float64
Bathroom         26631 non-null float64
Car              26129 non-null float64
Landsize         23047 non-null float64
BuildingArea     13742 non-null float64
YearBuilt        15551 non-null float64
CouncilArea      34854 non-null object
Lattitude        26881 non-null float64
Longtitude       26881 non-null float64
Regionname       34854 non-null object
Propertycount    34854 non-null float64
dtypes: float64(12), int64(1), object(8)
memory usage: 5.6+ MB
</pre></div>
</div>
<p>From the count we can see that there is significant missingness in many
of these variables. While we would like to impute as many of these
values as possible, we are especially interested in imputing the Price
of the home. Before we proceed with this, we can notice that Date and
YearBuilt columns are not datetimes, so we should convert these first.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mel</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">][:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">0</span>    <span class="mi">3</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">2016</span>
<span class="mi">1</span>    <span class="mi">3</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">2016</span>
<span class="mi">2</span>    <span class="mi">4</span><span class="o">/</span><span class="mi">02</span><span class="o">/</span><span class="mi">2016</span>
<span class="mi">3</span>    <span class="mi">4</span><span class="o">/</span><span class="mi">02</span><span class="o">/</span><span class="mi">2016</span>
<span class="mi">4</span>    <span class="mi">4</span><span class="o">/</span><span class="mi">03</span><span class="o">/</span><span class="mi">2017</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">Date</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">object</span>
</pre></div>
</div>
<p>Looking at the Date, we can see that the string is in a standard date
format, and we can then cast as a datetime.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mel</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">mel</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">],</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The Yearbuilt variable is a bit more challenging, since it was cast as a
float.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mel</span><span class="p">[</span><span class="s1">&#39;YearBuilt&#39;</span><span class="p">][:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">0</span>       <span class="n">NaN</span>
<span class="mi">1</span>       <span class="n">NaN</span>
<span class="mi">2</span>    <span class="mf">1900.0</span>
<span class="mi">3</span>       <span class="n">NaN</span>
<span class="mi">4</span>    <span class="mf">1900.0</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">YearBuilt</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</pre></div>
</div>
<p>Let&#8217;s write a custom function that converts the float first to integer,
then to string, if it is not NaN.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">conv_year</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
</pre></div>
</div>
<p>We apply this using the <code class="docutils literal"><span class="pre">apply</span></code> method, then convert to a PeriodIndex
object.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mel</span><span class="p">[</span><span class="s1">&#39;YearBuilt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mel</span><span class="p">[</span><span class="s1">&#39;YearBuilt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">conv_year</span><span class="p">)</span>
<span class="n">mel</span><span class="p">[</span><span class="s1">&#39;YearBuilt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">PeriodIndex</span><span class="p">(</span><span class="n">mel</span><span class="p">[</span><span class="s1">&#39;YearBuilt&#39;</span><span class="p">],</span><span class="n">freq</span><span class="o">=</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>We can verify that this is the desired result.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mel</span><span class="p">[</span><span class="s1">&#39;YearBuilt&#39;</span><span class="p">][:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">0</span>    <span class="n">NaT</span>
<span class="mi">1</span>    <span class="n">NaT</span>
<span class="mi">2</span>   <span class="mi">1900</span>
<span class="mi">3</span>    <span class="n">NaT</span>
<span class="mi">4</span>   <span class="mi">1900</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">YearBuilt</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">object</span>
</pre></div>
</div>
<p>We have seen the use of <code class="docutils literal"><span class="pre">isna</span></code> to make a missingness indicator
variable. We can easily do this to all of the variables and add
missingness indicators for all of them using a join.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mel_miss</span> <span class="o">=</span> <span class="n">mel</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
<span class="n">mel</span> <span class="o">=</span> <span class="n">mel</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mel_miss</span><span class="p">,</span><span class="n">rsuffix</span><span class="o">=</span><span class="s2">&quot;_miss&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now <code class="docutils literal"><span class="pre">mel</span></code> has twice the number of columns.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mel</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Index</span><span class="p">([</span><span class="s1">&#39;Suburb&#39;</span><span class="p">,</span> <span class="s1">&#39;Address&#39;</span><span class="p">,</span> <span class="s1">&#39;Rooms&#39;</span><span class="p">,</span> <span class="s1">&#39;Type&#39;</span><span class="p">,</span> <span class="s1">&#39;Price&#39;</span><span class="p">,</span> <span class="s1">&#39;Method&#39;</span><span class="p">,</span> <span class="s1">&#39;SellerG&#39;</span><span class="p">,</span>
       <span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">,</span> <span class="s1">&#39;Postcode&#39;</span><span class="p">,</span> <span class="s1">&#39;Bedroom2&#39;</span><span class="p">,</span> <span class="s1">&#39;Bathroom&#39;</span><span class="p">,</span> <span class="s1">&#39;Car&#39;</span><span class="p">,</span>
       <span class="s1">&#39;Landsize&#39;</span><span class="p">,</span> <span class="s1">&#39;BuildingArea&#39;</span><span class="p">,</span> <span class="s1">&#39;YearBuilt&#39;</span><span class="p">,</span> <span class="s1">&#39;CouncilArea&#39;</span><span class="p">,</span> <span class="s1">&#39;Lattitude&#39;</span><span class="p">,</span>
       <span class="s1">&#39;Longtitude&#39;</span><span class="p">,</span> <span class="s1">&#39;Regionname&#39;</span><span class="p">,</span> <span class="s1">&#39;Propertycount&#39;</span><span class="p">,</span> <span class="s1">&#39;Suburb_miss&#39;</span><span class="p">,</span>
       <span class="s1">&#39;Address_miss&#39;</span><span class="p">,</span> <span class="s1">&#39;Rooms_miss&#39;</span><span class="p">,</span> <span class="s1">&#39;Type_miss&#39;</span><span class="p">,</span> <span class="s1">&#39;Price_miss&#39;</span><span class="p">,</span> <span class="s1">&#39;Method_miss&#39;</span><span class="p">,</span>
       <span class="s1">&#39;SellerG_miss&#39;</span><span class="p">,</span> <span class="s1">&#39;Date_miss&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance_miss&#39;</span><span class="p">,</span> <span class="s1">&#39;Postcode_miss&#39;</span><span class="p">,</span>
       <span class="s1">&#39;Bedroom2_miss&#39;</span><span class="p">,</span> <span class="s1">&#39;Bathroom_miss&#39;</span><span class="p">,</span> <span class="s1">&#39;Car_miss&#39;</span><span class="p">,</span> <span class="s1">&#39;Landsize_miss&#39;</span><span class="p">,</span>
       <span class="s1">&#39;BuildingArea_miss&#39;</span><span class="p">,</span> <span class="s1">&#39;YearBuilt_miss&#39;</span><span class="p">,</span> <span class="s1">&#39;CouncilArea_miss&#39;</span><span class="p">,</span>
       <span class="s1">&#39;Lattitude_miss&#39;</span><span class="p">,</span> <span class="s1">&#39;Longtitude_miss&#39;</span><span class="p">,</span> <span class="s1">&#39;Regionname_miss&#39;</span><span class="p">,</span>
       <span class="s1">&#39;Propertycount_miss&#39;</span><span class="p">],</span>
      <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;object&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The simplest form of imputation is to replace the missing values in a
column with a single value. This can be accomplished with <code class="docutils literal"><span class="pre">fillna</span></code>
which can take either a single value or a Series. The Series in this
case has to have keys which are the column names to be filled, and the
values are what to fill with.</p>
<p>For example, suppose that for all of the float columns we want to impute
with the median, and for all of the rest we want to impute with the
mode. We can use the <code class="docutils literal"><span class="pre">select_dtypes</span></code> to select the columns of a
certain type.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">imp_values</span> <span class="o">=</span> <span class="n">mel</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># mode returns a DataFrame</span>
<span class="n">imp_values</span> <span class="o">=</span> <span class="n">imp_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mel</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">())</span>
</pre></div>
</div>
<p>We used <code class="docutils literal"><span class="pre">append</span></code> to combine the two resulting Series to give us the
following,</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">imp_values</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Suburb</span>                              <span class="n">Reservoir</span>
<span class="n">Address</span>                          <span class="mi">5</span> <span class="n">Charles</span> <span class="n">St</span>
<span class="n">Rooms</span>                                       <span class="mi">3</span>
<span class="n">Type</span>                                        <span class="n">h</span>
<span class="n">Method</span>                                      <span class="n">S</span>
<span class="n">SellerG</span>                                <span class="n">Jellis</span>
<span class="n">Date</span>                      <span class="mi">2017</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">28</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
<span class="n">YearBuilt</span>                                <span class="mi">1970</span>
<span class="n">CouncilArea</span>           <span class="n">Boroondara</span> <span class="n">City</span> <span class="n">Council</span>
<span class="n">Regionname</span>              <span class="n">Southern</span> <span class="n">Metropolitan</span>
<span class="n">Suburb_miss</span>                             <span class="kc">False</span>
<span class="n">Address_miss</span>                            <span class="kc">False</span>
<span class="n">Rooms_miss</span>                              <span class="kc">False</span>
<span class="n">Type_miss</span>                               <span class="kc">False</span>
<span class="n">Price_miss</span>                              <span class="kc">False</span>
<span class="n">Method_miss</span>                             <span class="kc">False</span>
<span class="n">SellerG_miss</span>                            <span class="kc">False</span>
<span class="n">Date_miss</span>                               <span class="kc">False</span>
<span class="n">Distance_miss</span>                           <span class="kc">False</span>
<span class="n">Postcode_miss</span>                           <span class="kc">False</span>
<span class="n">Bedroom2_miss</span>                           <span class="kc">False</span>
<span class="n">Bathroom_miss</span>                           <span class="kc">False</span>
<span class="n">Car_miss</span>                                <span class="kc">False</span>
<span class="n">Landsize_miss</span>                           <span class="kc">False</span>
<span class="n">BuildingArea_miss</span>                        <span class="kc">True</span>
<span class="n">YearBuilt_miss</span>                           <span class="kc">True</span>
<span class="n">CouncilArea_miss</span>                        <span class="kc">False</span>
<span class="n">Lattitude_miss</span>                          <span class="kc">False</span>
<span class="n">Longtitude_miss</span>                         <span class="kc">False</span>
<span class="n">Regionname_miss</span>                         <span class="kc">False</span>
<span class="n">Propertycount_miss</span>                      <span class="kc">False</span>
<span class="n">Price</span>                                  <span class="mi">870000</span>
<span class="n">Distance</span>                                 <span class="mf">10.3</span>
<span class="n">Postcode</span>                                 <span class="mi">3103</span>
<span class="n">Bedroom2</span>                                    <span class="mi">3</span>
<span class="n">Bathroom</span>                                    <span class="mi">2</span>
<span class="n">Car</span>                                         <span class="mi">2</span>
<span class="n">Landsize</span>                                  <span class="mi">521</span>
<span class="n">BuildingArea</span>                              <span class="mi">136</span>
<span class="n">Lattitude</span>                            <span class="o">-</span><span class="mf">37.8076</span>
<span class="n">Longtitude</span>                            <span class="mf">145.008</span>
<span class="n">Propertycount</span>                            <span class="mi">6763</span>
<span class="n">dtype</span><span class="p">:</span> <span class="nb">object</span>
</pre></div>
</div>
<p>Now we are prepared to impute with these values. We are only going to
impute with this simple scheme when CouncilArea is missing however,
which we will explain shortly.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">ca_na</span> <span class="o">=</span> <span class="n">mel</span><span class="p">[</span><span class="s1">&#39;CouncilArea&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
<span class="n">mel</span><span class="p">[</span><span class="n">ca_na</span><span class="p">]</span> <span class="o">=</span> <span class="n">mel</span><span class="p">[</span><span class="n">ca_na</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">imp_values</span><span class="p">)</span>
</pre></div>
</div>
<p>We will impute using the CouncilArea as a predictor, but when it is
missing we will need to impute using a single value for each column.
There are only three rows with missing CouncilArea though, so this is
just for completeness sake. For comparison purposes however, we can make
a copy of the Price and look at the distribution before and after
imputation with a single value.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">price</span> <span class="o">=</span> <span class="n">mel</span><span class="p">[</span><span class="s1">&#39;Price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
<p>We will first look at the histogram of Price when it is non-missing. We
can see from the imputed value above that the median is 870,000 AUD.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">price</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Histogram of Price: non-missing&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/missingness_52_0.png" src="../_images/missingness_52_0.png" />
<p>Contrasting this with the histogram of the Price after we impute with
the median for the non-missing, we see one immediate deficiency of
imputing with a single value.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">price</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">imp_values</span><span class="p">[</span><span class="s1">&#39;Price&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Histogram of Price: single value imputation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/missingness_54_0.png" src="../_images/missingness_54_0.png" />
<p>The histogram now has a spike at the imputed value. This indicates that
if we impute with a single value then the sample distribution will have
a point mass. Imputing with the median will preserve the median, but
statistics regarding the spread of the distribution will be lower, for
example, compare the median and standard deviation below (50% and std).</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">price</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">count</span>    <span class="mf">2.724700e+04</span>
<span class="n">mean</span>     <span class="mf">1.050173e+06</span>
<span class="n">std</span>      <span class="mf">6.414671e+05</span>
<span class="nb">min</span>      <span class="mf">8.500000e+04</span>
<span class="mi">25</span><span class="o">%</span>      <span class="mf">6.350000e+05</span>
<span class="mi">50</span><span class="o">%</span>      <span class="mf">8.700000e+05</span>
<span class="mi">75</span><span class="o">%</span>      <span class="mf">1.295000e+06</span>
<span class="nb">max</span>      <span class="mf">1.120000e+07</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">Price</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">price</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">imp_values</span><span class="p">[</span><span class="s1">&#39;Price&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">count</span>    <span class="mf">3.485700e+04</span>
<span class="n">mean</span>     <span class="mf">1.010838e+06</span>
<span class="n">std</span>      <span class="mf">5.719992e+05</span>
<span class="nb">min</span>      <span class="mf">8.500000e+04</span>
<span class="mi">25</span><span class="o">%</span>      <span class="mf">6.950000e+05</span>
<span class="mi">50</span><span class="o">%</span>      <span class="mf">8.700000e+05</span>
<span class="mi">75</span><span class="o">%</span>      <span class="mf">1.150000e+06</span>
<span class="nb">max</span>      <span class="mf">1.120000e+07</span>
<span class="n">Name</span><span class="p">:</span> <span class="n">Price</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</pre></div>
</div>
<p>If we would like to get a more plausible sample distribution for the
Price after imputation, then we have two choices: multiple imputation
(which we will not go into) and imputation using prediction.</p>
<p>In Pandas, you can also use <code class="docutils literal"><span class="pre">fillna</span></code> to impute with a time series by
filling in the entries by padding from a given value. This type of
padding can be done in a forward or backward fashion. While we could use
Date to impute the Price, it will likely be more effective to use either
locational information or all of the continuous/ordinal variables
including Date.</p>
</div>
<div class="section" id="imputation-by-prediction">
<h2>Imputation by Prediction<a class="headerlink" href="#imputation-by-prediction" title="Permalink to this headline">¶</a></h2>
<p>Recall that if a variable is MCAR then looking at the other variables
should not help the imputation process. If the Price is MAR then we can
impute by thinking of this as a prediction problem, with all other
variables and their missingness statuses as predictors and the Price as
a response.</p>
<p>We will first impute all of the variables using CouncilArea as the sole
predictor. We can simply think of this as grouping by the CouncilArea
and then imputing with a single value for that group and column.
CouncilArea is a good choice as a variable to condition on since it is
mostly non-missing, and as we will see in the next code block, when we
group by the CouncilArea there are no columns that are all missing in a
group. Hence, if we want to impute with the median or mode within a
group, this will always be well defined.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">ca_groupct</span> <span class="o">=</span> <span class="n">mel</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;CouncilArea&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="p">(</span><span class="n">ca_groupct</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
<span class="c1"># is there any column that is all NaN for any council?</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kc">False</span>
</pre></div>
</div>
<p>In order to impute within groups we will combine the <code class="docutils literal"><span class="pre">groupby</span></code> method
with the <code class="docutils literal"><span class="pre">transform</span></code>. The idea is that we want to make a
transformation within each group, and this can be accomplished in the
following way. But we first need to create a function that defines how
we want to impute within the groups (which is the tranformation that
needs to be applied).</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">impute_med</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;impute NaNs for Series x with median if it is a float and mode otherwise&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">median</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span>  <span class="o">==</span> <span class="s2">&quot;YearBuilt&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">mode</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">mode</span><span class="p">())</span>
</pre></div>
</div>
<p>In the above transformation, we test if the Series has a float dtype,
and if so fill the NaNs with the median, otherwise we use the mode. The
YearBuild variable is causing some troubles because the mode returns a
Series and not a single value, so we will deal with that variable
specifically by looking at the <code class="docutils literal"><span class="pre">name</span></code> of the Series.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">CA</span> <span class="o">=</span> <span class="n">mel</span><span class="p">[</span><span class="s1">&#39;CouncilArea&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># the process does not preserve CouncilArea, save it</span>
<span class="n">mel</span><span class="p">[</span><span class="o">~</span><span class="n">ca_na</span><span class="p">]</span> <span class="o">=</span> <span class="n">mel</span><span class="p">[</span><span class="o">~</span><span class="n">ca_na</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;CouncilArea&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">impute_med</span><span class="p">)</span>
<span class="n">mel</span><span class="p">[</span><span class="s1">&#39;CouncilArea&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CA</span> <span class="c1"># rewrite CouncilArea</span>
</pre></div>
</div>
<p>We can see that now all values have been imputed.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mel</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 34857 entries, 0 to 34856
Data columns (total 42 columns):
Suburb                34857 non-null object
Address               34857 non-null object
Rooms                 34857 non-null int64
Type                  34857 non-null object
Price                 34857 non-null float64
Method                34857 non-null object
SellerG               34857 non-null object
Date                  34857 non-null datetime64[ns]
Distance              34857 non-null float64
Postcode              34857 non-null float64
Bedroom2              34857 non-null float64
Bathroom              34857 non-null float64
Car                   34857 non-null float64
Landsize              34857 non-null float64
BuildingArea          34857 non-null float64
YearBuilt             34857 non-null object
CouncilArea           34857 non-null object
Lattitude             34857 non-null float64
Longtitude            34857 non-null float64
Regionname            34857 non-null object
Propertycount         34857 non-null float64
Suburb_miss           34857 non-null bool
Address_miss          34857 non-null bool
Rooms_miss            34857 non-null bool
Type_miss             34857 non-null bool
Price_miss            34857 non-null bool
Method_miss           34857 non-null bool
SellerG_miss          34857 non-null bool
Date_miss             34857 non-null bool
Distance_miss         34857 non-null bool
Postcode_miss         34857 non-null bool
Bedroom2_miss         34857 non-null bool
Bathroom_miss         34857 non-null bool
Car_miss              34857 non-null bool
Landsize_miss         34857 non-null bool
BuildingArea_miss     34857 non-null bool
YearBuilt_miss        34857 non-null bool
CouncilArea_miss      34857 non-null bool
Lattitude_miss        34857 non-null bool
Longtitude_miss       34857 non-null bool
Regionname_miss       34857 non-null bool
Propertycount_miss    34857 non-null bool
dtypes: bool(21), datetime64[ns](1), float64(11), int64(1), object(8)
memory usage: 6.3+ MB
</pre></div>
</div>
<p>Again, we can look at the histogram,</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mel</span><span class="p">[</span><span class="s1">&#39;Price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Histogram of Price: imputed by CouncilArea&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/missingness_68_0.png" src="../_images/missingness_68_0.png" />
<p>While there seems to be a larger spike around 1M AUD, the sample
distribution does look more like the original sample distribution.</p>
<p>We have seen how you can impute with a categorical variable as the
predictor using <code class="docutils literal"><span class="pre">groupby</span></code>. We can also think about using the other
variables, particularly the numerical variables, in a linear regressor.
Before we do this however, we would like to compare prediction with the
numerical variables against predicting with CouncilArea. To do this
let&#8217;s make a training and testing split of the observed Price data
(using the <code class="docutils literal"><span class="pre">Price_miss</span></code> variable). We will see the <code class="docutils literal"><span class="pre">sklearn</span></code> package
later, but for now, we will just import the <code class="docutils literal"><span class="pre">train_test_split</span></code>
function. This makes a randomized split of the data with a default of a
3:1 ratio for train and test sets respectively.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="k">import</span> <span class="n">train_test_split</span>

<span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">mel</span><span class="p">[</span><span class="o">~</span><span class="n">mel</span><span class="p">[</span><span class="s1">&#39;Price_miss&#39;</span><span class="p">]])</span>
</pre></div>
</div>
<p>We will extract the predictions in the form of a Series with the
CouncilArea as the index and the mean Price within that CouncilArea as
the values.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">ca_na</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;CouncilArea_miss&#39;</span><span class="p">]</span>
<span class="n">tr_preds</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="o">~</span><span class="n">ca_na</span><span class="p">][[</span><span class="s1">&#39;CouncilArea&#39;</span><span class="p">,</span><span class="s1">&#39;Price&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;CouncilArea&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
<p>We will then join this series to the full Price data with the
CouncilArea as the index. Notice that the left DataFrame is much larger
and has many duplicate indices, while the indices in the right DataFrame
are unique. Because this is a left join, the right Dataframe rows will
be multiplied to match the multiple rows on the left.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">test_dat</span> <span class="o">=</span> <span class="n">test</span><span class="p">[[</span><span class="s1">&#39;CouncilArea&#39;</span><span class="p">,</span><span class="s1">&#39;Price&#39;</span><span class="p">]]</span>
<span class="n">test_dat</span> <span class="o">=</span> <span class="n">test_dat</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;CouncilArea&#39;</span><span class="p">)</span>
<span class="n">test_dat</span> <span class="o">=</span> <span class="n">test_dat</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tr_preds</span><span class="p">,</span><span class="n">rsuffix</span><span class="o">=</span><span class="s1">&#39;_pred&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We can look at the result and see that the behavior is as expected, the
<code class="docutils literal"><span class="pre">Price_pred</span></code> is dependent on the CouncilArea.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">test_dat</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="dataframe">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Price</th>
      <th>Price_pred</th>
    </tr>
    <tr>
      <th>CouncilArea</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Banyule City Council</th>
      <td>1278000.0</td>
      <td>942259.175601</td>
    </tr>
    <tr>
      <th>Banyule City Council</th>
      <td>845000.0</td>
      <td>942259.175601</td>
    </tr>
    <tr>
      <th>Banyule City Council</th>
      <td>985000.0</td>
      <td>942259.175601</td>
    </tr>
    <tr>
      <th>Banyule City Council</th>
      <td>690000.0</td>
      <td>942259.175601</td>
    </tr>
    <tr>
      <th>Banyule City Council</th>
      <td>728500.0</td>
      <td>942259.175601</td>
    </tr>
  </tbody>
</table>
</div><p>We can simply calculate the square error test error using the <code class="docutils literal"><span class="pre">eval</span></code>
method. We have not gone over the <code class="docutils literal"><span class="pre">eval</span></code> method, but it is often
handy. Since the columns are named, we can write mathematical
expressions using them, then <code class="docutils literal"><span class="pre">eval</span></code> will evaluate it for every row of
the DataFrame. We then calculate the mean.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">CA_error</span> <span class="o">=</span> <span class="n">test_dat</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s1">&#39;(Price - Price_pred)**2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">CA_error</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mf">312621748714.5273</span>
</pre></div>
</div>
<p>Let&#8217;s consider using linear regression to predict the Price instead. We
will create a handy function to select the desired predictor and
response DataFrames below. We will exclude the non-numeric variables
from the predictors. Critically, the missingness indicators are all
included as predictor variables. We also cast the result as Numpy
Arrrays with dtype of float.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">select_preds</span><span class="p">(</span><span class="n">train</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
    <span class="n">X_tr</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">bool</span><span class="p">,</span><span class="nb">int</span><span class="p">])</span>
    <span class="n">Y_tr</span> <span class="o">=</span> <span class="n">X_tr</span><span class="p">[</span><span class="s1">&#39;Price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">del</span> <span class="n">X_tr</span><span class="p">[</span><span class="s1">&#39;Price&#39;</span><span class="p">]</span>
    <span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">X_tr</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">X_tr</span><span class="p">,</span> <span class="n">Y_tr</span> <span class="o">=</span> <span class="n">X_tr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span> <span class="n">Y_tr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Y_tr</span><span class="p">,</span> <span class="n">X_tr</span>
</pre></div>
</div>
<p>We then apply this to the train and test sets and fit OLS and predict on
the test set.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">Y_tr</span><span class="p">,</span> <span class="n">X_tr</span> <span class="o">=</span> <span class="n">select_preds</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
<span class="n">Y_te</span><span class="p">,</span> <span class="n">X_te</span> <span class="o">=</span> <span class="n">select_preds</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
<span class="n">ols_res</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">Y_tr</span><span class="p">,</span><span class="n">X_tr</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">Y_pred</span> <span class="o">=</span> <span class="n">ols_res</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_te</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">ols_res</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
<table class="simpletable">
<caption>OLS Regression Results</caption>
<tr>
  <th>Dep. Variable:</th>          <td>Price</td>      <th>  R-squared:         </th>  <td>   0.852</td>
</tr>
<tr>
  <th>Model:</th>                   <td>OLS</td>       <th>  Adj. R-squared:    </th>  <td>   0.852</td>
</tr>
<tr>
  <th>Method:</th>             <td>Least Squares</td>  <th>  F-statistic:       </th>  <td>   5871.</td>
</tr>
<tr>
  <th>Date:</th>             <td>Thu, 20 Sep 2018</td> <th>  Prob (F-statistic):</th>   <td>  0.00</td>
</tr>
<tr>
  <th>Time:</th>                 <td>09:42:51</td>     <th>  Log-Likelihood:    </th> <td>-2.9610e+05</td>
</tr>
<tr>
  <th>No. Observations:</th>      <td> 20435</td>      <th>  AIC:               </th>  <td>5.922e+05</td>
</tr>
<tr>
  <th>Df Residuals:</th>          <td> 20415</td>      <th>  BIC:               </th>  <td>5.924e+05</td>
</tr>
<tr>
  <th>Df Model:</th>              <td>    20</td>      <th>                     </th>      <td> </td>
</tr>
<tr>
  <th>Covariance Type:</th>      <td>nonrobust</td>    <th>                     </th>      <td> </td>
</tr>
</table>
<table class="simpletable">
<tr>
           <td></td>             <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>
</tr>
<tr>
  <th>Rooms</th>              <td> 3.419e+05</td> <td> 6794.377</td> <td>   50.315</td> <td> 0.000</td> <td> 3.29e+05</td> <td> 3.55e+05</td>
</tr>
<tr>
  <th>Distance</th>           <td>-4.733e+04</td> <td>  604.181</td> <td>  -78.341</td> <td> 0.000</td> <td>-4.85e+04</td> <td>-4.61e+04</td>
</tr>
<tr>
  <th>Postcode</th>           <td> 1160.6889</td> <td>   35.744</td> <td>   32.472</td> <td> 0.000</td> <td> 1090.628</td> <td> 1230.750</td>
</tr>
<tr>
  <th>Bedroom2</th>           <td> -3.49e+04</td> <td> 8042.990</td> <td>   -4.339</td> <td> 0.000</td> <td>-5.07e+04</td> <td>-1.91e+04</td>
</tr>
<tr>
  <th>Bathroom</th>           <td> 1.741e+05</td> <td> 6443.674</td> <td>   27.020</td> <td> 0.000</td> <td> 1.61e+05</td> <td> 1.87e+05</td>
</tr>
<tr>
  <th>Car</th>                <td> 5.412e+04</td> <td> 4224.249</td> <td>   12.812</td> <td> 0.000</td> <td> 4.58e+04</td> <td> 6.24e+04</td>
</tr>
<tr>
  <th>Landsize</th>           <td>    4.1204</td> <td>    0.998</td> <td>    4.128</td> <td> 0.000</td> <td>    2.164</td> <td>    6.077</td>
</tr>
<tr>
  <th>BuildingArea</th>       <td>   60.9449</td> <td>   10.398</td> <td>    5.861</td> <td> 0.000</td> <td>   40.565</td> <td>   81.325</td>
</tr>
<tr>
  <th>Lattitude</th>          <td>-1.258e+06</td> <td> 4.03e+04</td> <td>  -31.204</td> <td> 0.000</td> <td>-1.34e+06</td> <td>-1.18e+06</td>
</tr>
<tr>
  <th>Longtitude</th>         <td>-3.509e+05</td> <td> 1.05e+04</td> <td>  -33.521</td> <td> 0.000</td> <td>-3.71e+05</td> <td> -3.3e+05</td>
</tr>
<tr>
  <th>Propertycount</th>      <td>   -1.3879</td> <td>    0.743</td> <td>   -1.868</td> <td> 0.062</td> <td>   -2.844</td> <td>    0.069</td>
</tr>
<tr>
  <th>Suburb_miss</th>        <td> 6.778e-08</td> <td> 2.01e-08</td> <td>    3.380</td> <td> 0.001</td> <td> 2.85e-08</td> <td> 1.07e-07</td>
</tr>
<tr>
  <th>Address_miss</th>       <td>-2.664e-07</td> <td> 7.85e-08</td> <td>   -3.395</td> <td> 0.001</td> <td> -4.2e-07</td> <td>-1.13e-07</td>
</tr>
<tr>
  <th>Rooms_miss</th>         <td> 4.365e-07</td> <td> 1.29e-07</td> <td>    3.395</td> <td> 0.001</td> <td> 1.84e-07</td> <td> 6.88e-07</td>
</tr>
<tr>
  <th>Type_miss</th>          <td>   5.8e-08</td> <td> 1.71e-08</td> <td>    3.395</td> <td> 0.001</td> <td> 2.45e-08</td> <td> 9.15e-08</td>
</tr>
<tr>
  <th>Price_miss</th>         <td> 1.287e-08</td> <td>  3.8e-09</td> <td>    3.390</td> <td> 0.001</td> <td> 5.43e-09</td> <td> 2.03e-08</td>
</tr>
<tr>
  <th>Method_miss</th>        <td>-2.877e-08</td> <td>  8.5e-09</td> <td>   -3.385</td> <td> 0.001</td> <td>-4.54e-08</td> <td>-1.21e-08</td>
</tr>
<tr>
  <th>SellerG_miss</th>       <td>-2.241e-08</td> <td> 6.49e-09</td> <td>   -3.452</td> <td> 0.001</td> <td>-3.51e-08</td> <td>-9.68e-09</td>
</tr>
<tr>
  <th>Date_miss</th>          <td>-1.267e-08</td> <td> 3.77e-09</td> <td>   -3.365</td> <td> 0.001</td> <td>-2.01e-08</td> <td>-5.29e-09</td>
</tr>
<tr>
  <th>Distance_miss</th>      <td> -1.75e+05</td> <td> 2.91e+05</td> <td>   -0.601</td> <td> 0.548</td> <td>-7.45e+05</td> <td> 3.95e+05</td>
</tr>
<tr>
  <th>Postcode_miss</th>      <td> -1.75e+05</td> <td> 2.91e+05</td> <td>   -0.601</td> <td> 0.548</td> <td>-7.45e+05</td> <td> 3.95e+05</td>
</tr>
<tr>
  <th>Bedroom2_miss</th>      <td>-1.244e+06</td> <td> 3.38e+05</td> <td>   -3.677</td> <td> 0.000</td> <td>-1.91e+06</td> <td>-5.81e+05</td>
</tr>
<tr>
  <th>Bathroom_miss</th>      <td> 1.109e+06</td> <td> 3.37e+05</td> <td>    3.289</td> <td> 0.001</td> <td> 4.48e+05</td> <td> 1.77e+06</td>
</tr>
<tr>
  <th>Car_miss</th>           <td> 7.084e+04</td> <td> 2.85e+04</td> <td>    2.484</td> <td> 0.013</td> <td>  1.5e+04</td> <td> 1.27e+05</td>
</tr>
<tr>
  <th>Landsize_miss</th>      <td>-1.822e+04</td> <td> 1.12e+04</td> <td>   -1.630</td> <td> 0.103</td> <td>-4.01e+04</td> <td> 3691.804</td>
</tr>
<tr>
  <th>BuildingArea_miss</th>  <td> 1.264e+04</td> <td> 1.25e+04</td> <td>    1.015</td> <td> 0.310</td> <td>-1.18e+04</td> <td> 3.71e+04</td>
</tr>
<tr>
  <th>YearBuilt_miss</th>     <td> 4.737e+04</td> <td> 1.26e+04</td> <td>    3.757</td> <td> 0.000</td> <td> 2.27e+04</td> <td> 7.21e+04</td>
</tr>
<tr>
  <th>CouncilArea_miss</th>   <td>-4.717e+04</td> <td> 1.12e+05</td> <td>   -0.421</td> <td> 0.674</td> <td>-2.67e+05</td> <td> 1.72e+05</td>
</tr>
<tr>
  <th>Lattitude_miss</th>     <td>-1.956e+04</td> <td> 1.89e+04</td> <td>   -1.034</td> <td> 0.301</td> <td>-5.66e+04</td> <td> 1.75e+04</td>
</tr>
<tr>
  <th>Longtitude_miss</th>    <td>-1.956e+04</td> <td> 1.89e+04</td> <td>   -1.034</td> <td> 0.301</td> <td>-5.66e+04</td> <td> 1.75e+04</td>
</tr>
<tr>
  <th>Regionname_miss</th>    <td>-4.717e+04</td> <td> 1.12e+05</td> <td>   -0.421</td> <td> 0.674</td> <td>-2.67e+05</td> <td> 1.72e+05</td>
</tr>
<tr>
  <th>Propertycount_miss</th> <td>-4.717e+04</td> <td> 1.12e+05</td> <td>   -0.421</td> <td> 0.674</td> <td>-2.67e+05</td> <td> 1.72e+05</td>
</tr>
</table>
<table class="simpletable">
<tr>
  <th>Omnibus:</th>       <td>13579.846</td> <th>  Durbin-Watson:     </th>  <td>   2.004</td>
</tr>
<tr>
  <th>Prob(Omnibus):</th>  <td> 0.000</td>   <th>  Jarque-Bera (JB):  </th> <td>485785.597</td>
</tr>
<tr>
  <th>Skew:</th>           <td> 2.698</td>   <th>  Prob(JB):          </th>  <td>    0.00</td>
</tr>
<tr>
  <th>Kurtosis:</th>       <td>26.269</td>   <th>  Cond. No.          </th>  <td>1.20e+16</td>
</tr>
</table><br/><br/>Warnings:<br/>[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.<br/>[2] The smallest eigenvalue is 1.21e-20. This might indicate that there are<br/>strong multicollinearity problems or that the design matrix is singular.<p>There seem to be many strong predictors in the OLS, particularly,
variables like Rooms, Distance, Cars, Bathroom, but also the missingness
indicators seem to have some predictive power. Interestingly the postal
code is also predictive in a linear model, even though using the postal
code as a numerical variable in linear regression does not make much
sense, although nearby postal codes do tend to be close geographically.</p>
<p>Regardless, because we are doing a train-test split, we can feel
confident that the resulting test error is a good estimate of the risk
of the prediction.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">ols_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">Y_pred</span> <span class="o">-</span> <span class="n">Y_te</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ols_error</span> <span class="o">/</span> <span class="n">CA_error</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mf">0.7162549957690686</span>
</pre></div>
</div>
<p>We see that the test error from the OLS is 71.6% of the prediction from
the CouncilArea, and we can confidently use the OLS prediction to impute
the missing Prices.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">Y</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">select_preds</span><span class="p">(</span><span class="n">mel</span><span class="p">[</span><span class="o">~</span><span class="n">mel</span><span class="p">[</span><span class="s1">&#39;Price_miss&#39;</span><span class="p">]])</span>
<span class="n">_</span><span class="p">,</span> <span class="n">X_miss</span> <span class="o">=</span> <span class="n">select_preds</span><span class="p">(</span><span class="n">mel</span><span class="p">[</span><span class="n">mel</span><span class="p">[</span><span class="s1">&#39;Price_miss&#39;</span><span class="p">]])</span>
<span class="n">ols_res</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">Y_pred</span> <span class="o">=</span> <span class="n">ols_res</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_miss</span><span class="p">)</span>
<span class="n">mel</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mel</span><span class="p">[</span><span class="s1">&#39;Price_miss&#39;</span><span class="p">],</span><span class="s1">&#39;Price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Y_pred</span>
</pre></div>
</div>
<p>We have used more basic Pandas indexing and assignment to do the
imputation above. Try to follow the precise operations we have
performed. As usual, we can look at the sample distribution for the
resulting imputation.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">mel</span><span class="p">[</span><span class="s1">&#39;Price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Histogram of Price: imputed with OLS&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/missingness_89_0.png" src="../_images/missingness_89_0.png" />
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Missingness</a><ul>
<li><a class="reference internal" href="#looking-at-missingness-in-pandas">Looking at missingness in Pandas</a></li>
<li><a class="reference internal" href="#dealing-with-missingness-and-simple-imputation">Dealing with missingness and simple imputation</a></li>
<li><a class="reference internal" href="#imputation-by-prediction">Imputation by Prediction</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/unit1/missingness.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, James Sharpnack.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
      |
      <a href="../_sources/unit1/missingness.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>